<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="74" ground_alt="44" lat0="39.735078" lon0="116.164560" max_dist_from_home="500" name="IMAV2016_outdoor" security_height="2">
  <header>

#include "autopilot.h"
#include "subsystems/gps.h"
#include "subsystems/electrical.h"
#include "modules/sonar/sonar_bebop.h"
#include "subsystems/datalink/datalink.h"

#ifdef dc_Survey
#define LINE_START_FUNCTION dc_Survey(dc_distance_interval);
#define LINE_STOP_FUNCTION {dc_autoshoot = DC_AUTOSHOOT_STOP;}
#endif


#ifndef DropLifeVest
#define DropLifeVest() FALSE
#endif

#ifndef DropWater
#define DropWater() FALSE
#endif

#ifndef DropContainer
#define DropContainer() FALSE
#endif

#ifndef DetectWater
#define DetectWater() FALSE
#endif

#ifndef StartVisionMovingLandPad
#define StartVisionMovingLandPad() FALSE
#endif

#ifndef StopVision
#define StopVision() FALSE
#endif

#define ALT_WATER 		40			// TODO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#define ALT_LANDING_PLATFORM	45.36			// Verified
#define ALT_BOTTOM_WATER_BOX	44.36			// Verified

#define ALT_CLIMBOUT 		(ALT_LANDING_PLATFORM+12.0)
#define ALT_DROPLIFEVEST	(ALT_WATER+3.0)
#define ALT_MOVETOPICKUP	(ALT_WATER+5.0)
#define ALT_WATERPICKUP 	(ALT_WATER+0.5)
#define ALT_DROPWATER		(ALT_BOTTOM_WATER_BOX+2.2)
#define ALT_MOVETOLAND		(ALT_DROPWATER+1.0)
#define ALT_LANDING		(ALT_LANDING_PLATFORM+0.4)

  </header>
  <waypoints>
    <waypoint x="0.0" y=".0" name="HOME"/>
    <waypoint x="-7.6" y="15.4" name="CLIMB"/> <!-- Help with vertical take-off -->
    <waypoint lat="39.7352051" lon="116.1643026" name="STDBY"/>
    <waypoint x="-3.7" y="24.0" name="CRUISE"/> <!-- Help with large horizontal displacements -->

    <waypoint lat="39.7341917" lon="116.1631473" name="DROP"/> <!-- Drop LifeVest -->

    <waypoint lat="39.7348971" lon="116.1642900" alt="49" name="WG"/> <!-- Get Water -->
    <waypoint lat="39.7348969" lon="116.1642898" name="WD"/> <!-- Drop Water -->
    <waypoint x="250.0" y=".0" name="CAM"/>  <!-- Visual Guided Hovering -->

    <waypoint lat="39.7352051" lon="116.1643026" alt="50.0" name="TD"/> <!-- Normal Landing Location -->
    <waypoint lat="39.7352229" lon="116.1645240" name="ETD"/> <!-- Emergency Tough Down -->

    <waypoint x="300" y="-300" name="p1"/> <!-- Camera projection -->
    <waypoint x="300" y="300" name="p2"/>
    <waypoint x="-300" y="300" name="p3"/>
    <waypoint x="-300" y="-300" name="p4"/>

  
    <waypoint lat="39.734362" lon="116.163435" name="_water1"/>
    <waypoint lat="39.734377" lon="116.162869" name="_water4"/>
    <waypoint lat="39.733997" lon="116.162890" name="_water3"/>
    <waypoint lat="39.734002" lon="116.163352" name="_water2"/>
    
    <waypoint lat="39.735189" lon="116.163665" name="map1"/>
    <waypoint lat="39.735201" lon="116.162002" name="map2"/>
    <waypoint lat="39.733937" lon="116.161960" name="map3"/>
    <waypoint lat="39.733947" lon="116.163645" name="map4"/>
    
    <waypoint lat="39.735540" lon="116.166135" name="_OZ1"/>
    <waypoint lat="39.735523" lon="116.161088" name="_OZ4"/>
    <waypoint lat="39.732761" lon="116.161074" name="_OZ3"/>    
    <waypoint lat="39.732736" lon="116.166134" name="_OZ2"/>
        
    <waypoint lat="39.735425" lon="116.165030" name="_land1"/>
    <waypoint lat="39.735419" lon="116.164086" name="_land4"/>
    <waypoint lat="39.734731" lon="116.164080" name="_land3"/>
    <waypoint lat="39.734723" lon="116.165012" name="_land2"/>
  </waypoints>

  <sectors>
    <sector color="red" name="OZ">
      <corner name="_OZ1"/>
      <corner name="_OZ2"/>
      <corner name="_OZ3"/>
      <corner name="_OZ4"/>
    </sector>
    <sector color="blue" name="WATER">
      <corner name="_water1"/>
      <corner name="_water2"/>
      <corner name="_water3"/>
      <corner name="_water4"/>
    </sector>
    <sector color="green" name="MAP">
      <corner name="map1"/>
      <corner name="map2"/>
      <corner name="map3"/>
      <corner name="map4"/>
    </sector>
    <sector color="green" name="LAND">
      <corner name="_land1"/>
      <corner name="_land2"/>
      <corner name="_land3"/>
      <corner name="_land4"/>
    </sector>
  </sectors>

  <exceptions>
    <exception cond="(!InsideOZ(GetPosX(), GetPosY()) && !(nav_block == IndexOfBlock('flare_emergency')) && !(nav_block == IndexOfBlock('landed')) && !(nav_block == IndexOfBlock('WaitGPS')))" deroute="land_emergency"/>
    <exception cond="gps.hmsl > 104.36" deroute="land_emergency"/>
    <exception cond="datalink_time > 40" deroute="land_emergency"/>
  </exceptions>

  <blocks>

    <!-- BOOT -->
    <block name="WaitGPS">
      <call fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="holding_point">
      <call fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>

    <!-- START -->
    <block name="Start Engine" strip_button="Start Engine" strip_icon="resurrect.png" group="engine">
      <call fun="NavResurrect()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>

    <!-- GO -->
    <block name="Takeoff-Standby" strip_button="Takeoff-Standby" strip_icon="takeoff.png" group="takeoff">
      <exception cond="stateGetPositionEnu_f()->z > ALT_CLIMBOUT" deroute="Standby"/>
      <call fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block name="Takeoff-Map" strip_button="Takeoff-Map" strip_icon="survey.png" group="takeoff">
      <exception cond="stateGetPositionEnu_f()->z > ALT_CLIMBOUT" deroute="SurveyPoly"/>
      <call fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block name="Takeoff-Drop" strip_button="Takeoff-Drop" strip_icon="parachute.png" group="takeoff">
      <exception cond="stateGetPositionEnu_f()->z > ALT_CLIMBOUT" deroute="drop"/>
      <call fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block name="Takeoff-Water" strip_button="Takeoff-Water" group="takeoff">
      <exception cond="stateGetPositionEnu_f()->z > ALT_CLIMBOUT" deroute="pickup_water"/>
      <call fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>

    <!-- DEBUG (OBSERVE) -->

    <block name="Standby" strip_button="Standby" strip_icon="home.png" group="hover">
      <stay wp="STDBY"/>
    </block>

    <block name="stay_p1">
      <stay wp="p1"/>
    </block>

    <block name="go_p2">
      <go wp="p2"/>
      <deroute block="stay_p1"/>
    </block>

    <block name="line_p1_p2">
      <go from="p1" hmode="route" wp="p2"/>
      <stay until="stage_time>10" wp="p2"/>
      <go from="p2" hmode="route" wp="p1"/>
      <deroute block="stay_p1"/>
    </block>


    <block name="ComeBackAndLand" strip_button="ComeBackAndLand" strip_icon="land-right.png" group="hover">
      <call fun="StopVision()"/>
      <call fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="CLIMB" until="stateGetPositionEnu_f()->z > ALT_CLIMBOUT"/>
      <call fun="NavCopyWaypointPositionOnly(WP_CAM,WP_TD)"/>
      <call fun="NavCopyWaypointPositionOnly(WP_CRUISE,WP_TD)"/>
      <go wp="CRUISE"/>
      <deroute block="land"/>
    </block>

    <block name="CAM" strip_button="Follow-Vision-Geolocation-Results" strip_icon="lookdown.png" group="hover">
      <call fun="StartVision()"/>
      <stay wp="CAM"/>
    </block>


    <!-- DROPPINGS -->
    <block name="drop" group="drop">
       <go wp="DROP"/>
       <stay climb="nav_descend_vspeed" vmode="climb" wp="DROP" until="LessThan(stateGetPositionEnu_f()->z, ALT_DROPLIFEVEST)"/>
       <call fun="DropLifeVest()"/>
       <stay climb="nav_climb_vspeed" vmode="climb" wp="DROP" until="stateGetPositionEnu_f()->z > ALT_MOVETOPICKUP"/>
       <deroute block="pickup_water"/>
    </block>

    <block name="pickup_water" group="drop">
      <exception cond="DetectWater()" deroute="climb_with_water"/>
       <go wp="WG"/>
       <stay climb="nav_descend_vspeed" vmode="climb" wp="WG" until="LessThan(stateGetPositionEnu_f()->z, ALT_WATERPICKUP)"/>
    </block>
    <block name="climb_with_water" group="drop">
       <stay climb="nav_climb_vspeed" vmode="climb" wp="WG" until="stateGetPositionEnu_f()->z > ALT_CLIMBOUT"/>
       <deroute block="drop_water"/>
    </block>

    <block name="drop_water" group="drop">
       <go wp="WD"/>
       <stay climb="nav_descend_vspeed" vmode="climb" wp="WD" until="LessThan(stateGetPositionEnu_f()->z, ALT_DROPWATER)"/>
       <call fun="DropWater()"/>
    </block>
    <block name="drop_container" group="drop">
       <stay climb="nav_climb_vspeed" wp="WD" until="NavBlockTime() > 2"/>
       <call fun="DropContainer()"/>
       <stay climb="nav_climb_vspeed" vmode="climb" wp="WD" until="stateGetPositionEnu_f()->z > ALT_MOVETOLAND"/>
       <deroute block="land"/>
    </block>


    <!-- SURVEYS -->

<!--
    <block group="survey" name="Survey S1-S2 NS" strip_button="Survey-NS-S1-S2" strip_icon="survey.png">
      <call fun="nav_survey_rectangle_rotorcraft_setup(WP_S1, WP_S2, sweep, NS)"/>
      <deroute block="Survey RECTANGLE RUN"/>
    </block>
    <block group="survey" name="Survey S1-S2 EW" strip_button="Survey-EW-S1-S2" strip_icon="survey_we.png">
      <call fun="nav_survey_rectangle_rotorcraft_setup(WP_S1, WP_S2, sweep, WE)"/>
      <deroute block="Survey RECTANGLE RUN"/>
    </block>
    <block name="Survey RECTANGLE RUN">
      <exception cond="rectangle_survey_sweep_num >= 1" deroute="Standby"/>
      <call fun="nav_survey_rectangle_rotorcraft_run(WP_S1, WP_S2)"/>
    </block>
-->

    <block group="survey" name="SurveyPoly" strip_button="Survey-Polygon-Map" strip_icon="googleearth.png">
      <call fun="nav_survey_poly_setup_towards(WP_map1, 4, sweep, WP_map2)"/>
      <deroute block="Survey Poly RUN"/>
    </block>
    <block name="Survey Poly RUN">
      <exception cond="PolySurveySweepNum >= 5" deroute="drop"/>
      <call fun="nav_survey_poly_run()"/>
    </block>

    <!-- LANDINGS -->
    <block name="land" strip_button="Land at TD" strip_icon="land-right.png" group="landing">
      <go wp="TD"/>
      <deroute block="flare"/>
    </block>

<!--
    <block name="visual_flare" strip_button="VisualLanding-CAM" strip_icon="cam_lock.png" group="landing">
      <exception cond="NavDetectGround()" deroute="holding_point"/>
      <exception cond="!nav_is_in_flight()" deroute="landed"/>
      <exception cond="!InsideLAND(GetPosX(), GetPosY())" deroute="land"/>
      <call fun="StartVisionLand()"/>
      <call fun="NavStartDetectGround()"/>
      <stay climb="-0.2" vmode="climb" wp="CAM"/>
      <deroute block="landed"/>
    </block>
-->

    <block name="flare">
      <exception cond="LessThan(sonar_bebop.distance,0.8)" deroute="touch_down"/>
      <stay wp="TD"/>
    </block>

    <block name="touch_down">
      <attitude pitch="0" roll="0" throttle="0.15" until="NavBlockTime() > 1" vmode="throttle"/>
      <deroute block="landed"/>
    </block>

    <!-- EMERGENCY -->
    <block name="land_emergency" strip_button="Land Here" strip_icon="downdown.png">
      <call fun="NavSetWaypointHere(WP_ETD)"/>
      <deroute block="flare_emergency"/>
    </block>
    <block name="flare_emergency">
      <exception cond="NavDetectGround()" deroute="landed"/>
      <exception cond="!nav_is_in_flight()" deroute="landed"/>
      <call fun="NavStartDetectGround()"/>
      <!--stay climb="nav_descend_vspeed" vmode="climb" wp="ETD"/-->
      <attitude pitch="0" roll="0" throttle="0.2" until="FALSE" vmode="throttle"/>
      <deroute block="landed"/>
    </block>


    <!-- INERT -->
    <block name="landed" strip_button="Kill" strip_icon="kill.png" group="landing">
      <call fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>

  </blocks>

</flight_plan>
