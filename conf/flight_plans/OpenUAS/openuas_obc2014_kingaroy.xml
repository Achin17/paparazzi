<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">
<!-- This is the Flightplan of Team OpenUAS from the Netherlands for use in the
     Australian UAV Outback Challenge of 2014. 
     
     Read about this challenge here:
     http://www.uavoutbackchallenge.com.au/
     
     Thanks to all involved, specifically all the help from CdW, DD, BR, GdC, AvdL
     * TU Delft University of Technology, L&R http://www.tudelft.nl
     * MAVLab - http://mavlab.info
     * 1 bit squared http://1bitsquesred.com
     * everyone else who helped out

TYPE 1 OPERATION Flightplan, fully autonomous in-air joe detection integration

Now with integrated TYPE2 operations option (soon...)
TYPE 2 OPERATION Flightplan, fully autonomous search, but on ground joe detection integration

STRATEGY: 

# Have one flightplan which does it all, no need to upload anything!

USAGE: 

To use the flightplan's embedded options:

# Put the Waypoint SCRUTINEERING inside the mission boundary the the SCRUTINEERING flight will be executed.
# Put the Waypoint JOE inside the mission boundary the the RESCUE only part of the flight will be executed.(TYPE2)

NOTES:

# This flightplan contains both the SR, as default mission and the Scruteneering flight.
# Mission boundary coodinates are for both Scrutineering and SnR the same
# Alert boundaries are different for Scrutineering and SnR Missions

TODO:
# Latest coordinates of KMZ of 20131017, a 100% validationcheck.
# TODO: 
# add times to blocks to prevent to early forcedcrash. e.g after 2 second from tkeof border cannot be crossed in reality, so if triggered do a softcircledown or so
# or mabye calculate distance and look at airframe REAL max ground speed(with wind in backeve) and deduct time it would take, if within < margin it cannot be missionborder
# but if scrutineering day, than it can be since we test it closeby mission boundary
# TODO autonomous calculation AF-TD dependand on measured wind direction
# add even **better** exceptions
# Response of cam picture if successful of not via TICKET module
#If we set the air crowbrake make sure it is retracted again when contining normal ops (maybe or above a certain airspeed?)

-->

<!-- Test via command xmlwf yourfligtplanname.xml for welformedness of the xml document -->
<!-- The base lat lon of the flightplan is the AIRFIELDHOME point -->
<!-- The ground_alt will be set later on also with real testflight, mind the ground height profile please -->
<!-- WARNING: max_dist_from_home very very likely never be reached due to boundary crossing first -->
<flight_plan name="OpenUAS OBC2014" ground_alt="0" alt="120" lat0="-26.5847810000" lon0="151.8423250000" security_height="70" max_dist_from_home="10000" qfu="70">
<!-- ******************************** HEADERS ****************************** -->
<header>
//Set Generic options
    #include "autopilot.h"
//Enable AHRS Health test functions
    #include "subsystems/ahrs.h"
//Enable advanced electrical power functions 
    #include "subsystems/electrical.h"
//Enable extra nav functionality
<!--
Now done in modules
    #include "subsystems/nav.h"    
    #include "subsystems/navigation/nav_line.h"
    #include "subsystems/navigation/OSAMNav.h"

    #include "subsystems/navigation/drop.h"
-->
//Enable datalink tests
    #include "subsystems/datalink/datalink.h"

// PHOTOGRAMMETRY settings

    #define PHOTOGRAMMETRY_SWEEP_ANGLE 53		// Degrees from the North
    #define PHOTOGRAMMETRY_OVERLAP 30		// 1-99 Procent
    #define PHOTOGRAMMETRY_SIDELAP 20		// 1-99 Procent
    #define PHOTOGRAMMETRY_RESOLUTION 50		// mm pixel projection size
    
// Automatic include of Camera trigger if camera is present and only take pictures inside polygon

// Incluse airframe.h To be able to use specific variables 
    #include "generated/airframe.h"

// Completly replace with onboard recon copmpter interface
    #ifdef DC_AUTOSHOOT_QUARTERSEC_PERIOD
    #include "modules/digital_cam/led_cam_ctrl.h"
    //TODO make shooting distance not periodic
    #define LINE_START_FUNCTION dc_autoshoot = DC_AUTOSHOOT_PERIODIC;
    #define LINE_STOP_FUNCTION dc_autoshoot = DC_AUTOSHOOT_STOP;
    #endif

//For interaction with the Flight termination Device (FTD) 
    #define RCChannel(_x) ((*fbw_state).channels[_x])

//DANGER WARNING
// define ACTIVATED_FTD 0

//Enable energy control commands from within flightplan
#include "firmwares/fixedwing/guidance/energy_ctrl.h"

//To be able to cound how many times we had a linkloss to interactivly react to commshold block
static inline uint16_t datalinkloss_occurence_counter = 0;
//To be able to count how many times we had a possible "Outback Joe" found but not approved to interactivly react to come back after two(2) times incorrect
//Then we can perform an on the ground search in photos and reland to drop bottle (TYPE2 mission stage)
static inline uint16_t outbackjoe_possibly_found_occurence_counter = 0;

//Needed for the DROP function
static inline uint16_t G = 9.81;

  </header>
<!-- ******************************* WAYPOINTS ***************************** -->
  <waypoints>
    <waypoint name="AIRFIELDHOME" lat="-26.5847810000" lon="151.8423250000" height="2."/> <!-- Note that Scrutineering AIRFIELDHOME is the same as in the SnR mission -->
    <waypoint name="HOME" x="0." y="0." height="2."/> <!-- NEEDED FOR DEBUG ONLY -->
    <waypoint name="THROWSPOT" x="0." y="30." height="0."/>
    <waypoint name="STDBY" x="0." y="-130." height="95."/> <!-- DEBUG ONLY For helping out in flightplan security of states-->
    <waypoint name="CLIMB" x="50." y="390." height="80."/> <!-- TODO make Hidden, should be dynamic based on throw direction-->
    <waypoint name="COMMSHOLD" lat="-26.6072120000" lon="151.8453890000" height="115."/>
    <!-- DANGER, DEBUG ONLY Disable later on, used for FDT Debugging only -->
    <waypoint name="TESTTOOFAR" x="800." y="-100." height="115."/><!-- DANGER, DEBUG ONLY Disable later on, used for FDT Debugging only -->

<!-- Set this and Upload for  scrutineering day --> <!-- OR,  IDEA base it on throwing spot position maybe-->
<!--      <waypoint name="_SCRUTINEERINGDAY" x="0." y="0." height="0."/> -->
<!-- Set inside and it will mean a scrutineer flight day -->
    <waypoint name="_SCRUTINEERINGDAY" x="-999." y="-999." height="0."/> 

<!-- MB = Mission Boundary -->
    <waypoint name="_MB1"  lat="-26.5695640000" lon="151.8373730000" height="400."/><!-- Todo set boundary to the QNH baro top boundary height of 1500ft AMSL? AGL-->
    <waypoint name="_MB2"  lat="-26.5699560000" lon="151.8394050000" height="400."/>
    <waypoint name="_MB3"  lat="-26.5768230000" lon="151.8411420000" height="400."/>
    <waypoint name="_MB4"  lat="-26.5769900000" lon="151.8400450000" height="400."/>
    <waypoint name="_MB5"  lat="-26.5812271666" lon="151.8410624807" height="400."/>
    <waypoint name="_MB6"  lat="-26.5820599087" lon="151.8425026348" height="400."/>
    <waypoint name="_MB7"  lat="-26.5791790000" lon="151.8493290000" height="400."/>
    <waypoint name="_MB8"  lat="-26.5900093277" lon="151.8509739535" height="400."/>
    <waypoint name="_MB9"  lat="-26.6095740000" lon="151.8631000000" height="400."/>
    <waypoint name="_MB10" lat="-26.6389580000" lon="151.8588390000" height="400."/>
    <waypoint name="_MB11" lat="-26.6449723895" lon="151.8472241047" height="400."/>
    <waypoint name="_MB12" lat="-26.6435720000" lon="151.8303500000" height="400."/>
    <waypoint name="_MB13" lat="-26.5875990000" lon="151.8344050000" height="400."/>
<!-- AB = Alert Boundary -->
<!-- TODO real positions and better naming-->
<!--
    <waypoint name="_AB1"  lat="-26.5695640000" lon="151.8373730000" height="400."/>
    <waypoint name="_AB2"  lat="-26.5699560000" lon="151.8394050000" height="400."/>
    <waypoint name="_AB3"  lat="-26.5768230000" lon="151.8411420000" height="400."/>
    <waypoint name="_AB4"  lat="-26.5769900000" lon="151.8400450000" height="400."/>
    <waypoint name="_AB5"  lat="-26.5812271666" lon="151.8410624807" height="400."/>
    <waypoint name="_AB6"  lat="-26.5820599087" lon="151.8425026348" height="400."/>
    <waypoint name="_AB7"  lat="-26.5791790000" lon="151.8493290000" height="400."/>
    <waypoint name="_AB8"  lat="-26.5900093277" lon="151.8509739535" height="400."/>
    <waypoint name="_AB9"  lat="-26.6095740000" lon="151.8631000000" height="400."/>
    <waypoint name="_AB10" lat="-26.6389580000" lon="151.8588390000" height="400."/>
    <waypoint name="_AB11" lat="-26.6449723895" lon="151.8472241047" height="400."/>
    <waypoint name="_AB12" lat="-26.6435720000" lon="151.8303500000" height="400."/>
    <waypoint name="_AB13" lat="-26.5875990000" lon="151.8344050000" height="400."/>
-->

<!-- SA = Search Area -->
    <waypoint name="SA1" lat="-26.6174450000" lon="151.8431840000" height="115."/>
    <waypoint name="SA2" lat="-26.6191710000" lon="151.8555730000" height="115."/>
    <waypoint name="SA3" lat="-26.6378430000" lon="151.8515970000" height="155."/>
    <waypoint name="SA4" lat="-26.6388280000" lon="151.8491210000" height="155."/>
    <waypoint name="SA5" lat="-26.6373930000" lon="151.8393860000" height="155."/>

<!-- Scrutineering Course -->
<!-- South * East
TST-1 = -26° 34' 58.9" * 151° 50' 16.2"
TST-2 = -26° 35' 04.1" * 151° 50' 44.5"
TST-3 = -26° 35' 23.2" * 151° 50' 45.9"

OK?
-->
    <waypoint name="TST-1" lat="-26.5837620409" lon="151.8379376113" height="115."/>
    <waypoint name="TST-2" lat="-26.5859618185" lon="151.8451373142" height="115."/>
    <waypoint name="TST-3" lat="-26.5902280387" lon="151.8400929439" height="115."/>

<!-- extra boundary maybe add it -->
<!-- ABS = Alert Boundary scrutineering flight -->
<!-- TODO real positions and better naming-->
<!--
    <waypoint name="_ABS1" lat="" lon="" height="400."/>
    <waypoint name="_ABS2" lat="" lon="" height="400."/>
    <waypoint name="_ABS3" lat="" lon="" height="400."/>
-->

<!-- RELATIVE COORD, not finished HINT are calculated during build based on flightplan set lat long coordinates so grab-->
<!-- MB = Mission Boundary -->
<!--
    <waypoint name="MB1" x="-85.08" y="909.9"/>
    <waypoint name="MB2" x="117.1" y="866.4"/>
    <waypoint name="MB3" x="289.8" y="102.9"/>
    <waypoint name="MB4" x="210.5" y="48.8"/>
    <waypoint name="MB5" x="370.2" y="-418.5"/>
    <waypoint name="MB6" x="919.0" y="-82.16"/>
    <waypoint name="MB7" x="1458.0" y="-2418.0"/>
    <waypoint name="MB8" x="3631.0" y="-2418.0"/>
    <waypoint name="MB9" x="4358.0" y="-7531.0"/>
    <waypoint name="MB10" x="-783.4" y="-7319.0"/>
    <waypoint name="MB11" x="-380.1" y="-1096.0"/>
    <waypoint name="MB12" x="-380.1" y="-1096.0"/>
    <waypoint name="MB13" x="-380.1" y="-1096.0"/>

-->

<!-- SA = Search Area -->
<!--
    <waypoint name="SA1" x="492.8" y="-4414.0" height="115."/>
    <waypoint name="SA2" x="1725.0" y="-4606.0" height="115."/>
    <waypoint name="SA3" x="1330.0" y="-6682.0" height="155."/>
    <waypoint name="SA4" x="1083.0" y="-6792.0" height="155."/>
    <waypoint name="SA5" x="-115.2" y="-6632.0" height="155."/>
-->

<!-- EL = Entry and Exit Lanes -->
    <waypoint name="EL1" lat="-26.6072120000" lon="151.8453890000" height="115."/>
    <waypoint name="EL2" lat="-26.6174980000" lon="151.8435670000" height="115."/>
    <waypoint name="EL3" lat="-26.6183650000" lon="151.8497880000" height="115."/>
    <waypoint name="EL4" lat="-26.6080920000" lon="151.8516460000" height="115."/>

    <waypoint name="AMAZED" lat="-26.5940360000" lon="151.8427090000" height="115."/>

<!-- Additional VIA_EL2 Waypoint since we must go *via* EL2, and to have a little
    more meters optimal for our scan strips entry, otherwhise we could miss one
    photo and not spot Joe. So not via Paris to Rome, but Via EL2 to Joe -->

    <waypoint name="VIAEL2" lat="-26.6174980000" lon="151.8435670000" height="115."/>

<!-- For the Payload release -->
    <!-- <waypoint name="WAIT" x="-70." y="-70." height="115."/> --> <!-- TODO Check is needed or better solution possible for Pre-tests -->
    <waypoint name="BASELEG" x="-20." y="0."/>

<!-- Position where Outback Joe would be located. If this waypoint is situated
     outside search area(The default situation), by this way the flightplane
     -knows if it should start a search phase. If it is moved inside the area it
      will start a rescue phase, a.k.a bottledrop.  -->

<!-- Note that waypoint *Height* of 0m is the OUTBACKJOE, Joe -->

    <waypoint name="OUTBACKJOE" x="666." y="777." height="0."/>
 <!-- The START from here towards target(Joe), wile dynamically calculating the RELEASE point to target the OUTBACKJOE -->
    <waypoint name="START" x="-100" y="300" height="65."/>

    <!-- Note that 70m is the release height, we are not allowed to go below
    60 meters and need at least some GPS height fluctuation into account
    Also if we steeply move UP from START to RELEASE the release will maybe a
    little more accurate, hmmmm theoretically -->
    <waypoint name="RELEASE" x="-100." y="400." height="75."/>

<!-- For autonomous landing -->
    <waypoint name="AF" x="177.4" y="45.1" height="30."/> <!-- AutoFinal -->
    <waypoint name="TD" x="28.8" y="57.0" height="0."/> <!-- Touchdown -->
    <waypoint name="_BASELEG" x="-100" y="350"/>
  </waypoints>

<!-- ******************************** SECTORS ****************************** -->
<!-- Sectors are good for displaying an overlay -->
  <sectors>
    <sector name="MissionBoundary" color="yellow">
      <corner name="_MB1"/>
      <corner name="_MB2"/>
      <corner name="_MB3"/>
      <corner name="_MB4"/>
      <corner name="_MB5"/>
      <corner name="_MB6"/>
      <corner name="_MB7"/>
      <corner name="_MB8"/>
      <corner name="_MB9"/>
      <corner name="_MB10"/>
      <corner name="_MB11"/>
      <corner name="_MB12"/>
      <corner name="_MB13"/>
    </sector>

<!--  maybe add an additional allert boundary -->
<!-- <sector name="AlertMissionBoundary" color="orange">
      <corner name="_AB1"/>
      <corner name="_AB2"/>
      <corner name="_AB3"/>
      <corner name="_AB4"/>
      <corner name="_AB5"/>
      <corner name="_AB6"/>
      <corner name="_AB7"/>
      <corner name="_AB8"/>
      <corner name="_AB9"/>
      <corner name="_AB10"/>
      <corner name="_AB11"/>
      <corner name="_AB12"/>
      <corner name="_AB13"/>
    </sector>
-->
    <sector name="SurveyArea" color="green">
      <corner name="SA1"/>
      <corner name="SA2"/>
      <corner name="SA3"/>
      <corner name="SA4"/>
      <corner name="SA5"/>
    </sector>
  </sectors>

<!-- ****************************** EXCEPTIONS ***************************** -->
  <exceptions>
<!-- WARNING these are Global Exeption, bettersome to stuff in a flightplan block-->
    <!-- If datalink is lost for more than 10 seconds and we are in launched state -->

    <!-- below for the real SnR --> <!--  TODO: if datalinkloss but still closeby move to commhold? strange better airfiledhome loiter IMHO -->
    <exception cond="And(datalink_time > 10, launch > 0)" deroute="CommsHoldLoiter"/> <!-- deroute="AirfieldHomeLoiter"/> -->
    <!-- Case of loss of GPS AND loss of datalink -->
    <!-- <exception cond="And(datalink_time > 10, !GpsFixValid())" deroute="ForcedCrash"/> --><!--921 1500f TODO add margin?-->
    <exception cond="Or(!InsideMissionBoundary(GetPosX(), GetPosY()), GetPosAlt() > ground_alt + 921)" deroute="ForcedCrash"/>
    
 <!--   <exception cond="if Joefoundandretunvalformticket deroute="Waitforjudges"/>-->

    <!--  If we are allowed to fly higher otherwise to do rules do not state to crash if heigher then 400m -->
    <!-- <exception cond="datalink_time > 1330" deroute="Standby"/> --> <!-- A loss of link set to max calculated mission time, unlikely to ever occur befor voltage level drop exeption -->

    <!-- Optional check, if at seconds of launch GPS is lost -->
    <!-- <exception cond="And(launch, gps_lost)" deroute="killengine" or test for heighht 40M or so/> -->
    <!-- see if we can get correct AP voltage -->

    <!-- not used yet maybe switch it on <exception cond="10.0 > PowerVoltage()" deroute="Standby"/> -->
    <!-- not used yet maybe switch it on <exception cond="11.0 > vsupply" deroute="Standby"/> -->
 <!--  is less safe and has less chance of AC recovery. It states battery LOW, not battery critical -->
<!--  <exception cond="electrical.bat_low && !(nav_block == IndexOfBlock('Setting_home_location')) && !(nav_block == IndexOfBlock('Holding_point') && !(nav_block == IndexOfBlock('Land')))" deroute="Land"/>-->
<!--<TODO: Add somethin like pre_call="if (!InsideRed(GetPosX(), GetPosY())) NavKillThrottle();-->
  </exceptions>

<!-- *********************************************************************** -->
<!-- ********************** FLIGHTPLAN STARTINGPOINT *********************** -->
<!-- *********************************************************************** -->

<!-- *********** Wait for GPS fix, 3D by default *********** -->
  <blocks>
    <block name="Startup">
      <!-- IDEA Close the hatch so not able to insert payload before there is a 3D fix , however maybe not so handy anyhow since we need to wat be fre we can insert-->
      <!--  <set value="NavDropCloseHatch" var="unit"/> -->
      <set value="1" var="kill_throttle"/>
<!-- if no valid fix or gps accuracy> 15m or no AHRS , it a no-go wait-->
      <while cond="!GpsFixValid() || gps.pacc > 1500 || !(ahrs.status == AHRS_RUNNING)"/>
    </block>
    
<!-- *********** Set the ground reference height and the home position *********** -->
<!-- a second init will follow since the plane thrower will still walk to launchpoint -->

    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 8)"/><!--  TODO see if a wait is really needed -->
      <call fun="NavSetGroundReferenceHere()"/>
      <call fun="NavSetWaypointHere(WP_HOME)"/>
    </block>

    <!-- *********** Set the ground reference height and the home position *********** -->

<!-- a second init will follow since the plane thrower will still walk to launchpoint-->

    <block name="Setting_home_location">
      <while cond="gps.pacc > 1000"/><!--at least 10m precision needed  TODO  continue if not within 10 seconds --><!-- TODO better flow-->
      <call fun="NavSetGroundReferenceHere()"/>
      <call fun="NavSetWaypointHere(WP_HOME)"/>
      <call fun="NavSetWaypointHere(WP_AIRFIELDHOME)"/><!-- <FOR TESTS only disable in real mission -->
      <!--  TODO Set QNH here based on GPS height if allowed from commitee -->

      <!-- We must have RC at least once switched on just to test, this check can be deleted if everything works 100% in Auto2 -->
      <while cond="RCLost()"/> <!-- to make sure we do not hop to AUTO2 and engine starts running , at least switch on then maybe off if you wantto -->
      <!-- TODO maybe switch on ACL blick as soon as we are ready to go  -->
    </block>

<!-- *********** Throttle off holdingpoint *********** -->
    <block name="Holding point">
     <!--  TODO: make some movements on all defelctros as a sign we are in holding and to see if all works Maybe a separate testblock-->
      <!--  <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/> -->
     
      <!--Just to make sure in case of flightplan mishap, it is no too far away -->
      <!-- <set var="waypoints[WP_START].x" value="WaypointX(WP_EL2) + 50"/> -->
      <!-- <set var="waypoints[WP_START].y" value="WaypointY(WP_EL2) + 50"/> -->
      <call fun="NavKillThrottle()"/>
      <set value="1" var="kill_throttle"/> <!-- maybe replace with <call fun="NavKillThrottle()"/> -->
      <attitude pitch="0" roll="0" throttle="0" vmode="throttle" until="FALSE"/><!-- maybe not moving the plane would still make a test of defelction possible -->
<!-- If over 50% throttleis given auto2 takeoff is initiated, it is not an RC steering method, just a trigger, make sure transmiter is set in auto2 mode, or else switched off -->
      <!-- <exception cond="RCChannel(RADIO_THROTTLE) > 1600" deroute="Takeoff"/> --><!-- Todo ACtivate if everything works-->
    </block>

<!-- *********************************************************
     *********** Search Area Entry Procedure Start ***********
     ***************************************************** -->

    <block key="t" name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
      <call fun="NavSetWaypointHere(WP_THROWSPOT)"/>
    <!--  <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/> -->
    <!--  <set value="3000" var="ap_state->commands[COMMAND_CAMBER]"/> -->
      <!--<exception cond="estimator_z > ground_alt+60" deroute="determineflighttype"/>-->

      <set value="0" var="kill_throttle"/>
      <set value="1" var="launch"/>
      <set value="0" var="autopilot_flight_time"/>
      <call fun="NavSetWaypointHere(WP_HOME)"/>
      <while cond="LessThan(NavBlockTime(), 3)"/>
      <call fun="NavSetGroundReferenceHere()"/>
      <while cond="LessThan(NavBlockTime(), 3)"/>
      <call fun="NavSetWaypointHere(WP_AIRFIELDHOME)"/>
      <set value="0" var="kill_throttle"/>
      <set value="1" var="launch"/>
      <set value="0" var="autopilot_flight_time"/>
<!-- TODO disable deceleron and maybe set a little camber if at all possible-->
     <!-- <set value="3000" var="ap_state->commands[COMMAND_CAMBER]"/> -->
      <deroute block="Climbout"/>
    </block>

<!-- TODO test needed pitch value -->
    <block name="Climbout">
      <!--<exception cond="rc_status==RC_REALLY_LOST" after 3 seconds and no IMU deroute="softlydown">if using RC stil on with a Auto2 mode switch-->
      <attitude pitch="10" roll="0" throttle="1.0" until="GetPosAlt() > ground_alt+40" vmode="throttle"/>
    </block>

    <block name="determineflighttype">
      <exception cond="InsideMissionBoundary(WaypointX(WP__SCRUTINEERINGDAY), WaypointY(WP__SCRUTINEERINGDAY))" deroute="Scrutineering Autonomy Start"/>
    </block>

<!-- *********************************************************
     *********** Search Area Entry Procedure Start ***********
     ***************************************************** -->

<!-- maybe a HelperWaypoint to gettart n return from a mission Tracking to EL1
      <set value="0" var="ap_state->commands[COMMAND_CAMBER]"/>
      <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/>-->

<!-- *********** Track to EL-1 *********** -->
    <block name="TrackToEL1">
      <set var="v_ctl_auto_throttle_cruise_throttle" value="V_CTL_AUTO_THROTTLE_MAX_CRUISE_THROTTLE"/> <!-- TODO see if this forced throttle stuff will work -->
      <go wp="EL1" hmode="route" throttle=".99"/>
    </block>
    <!--  maybe add other waypoint to enterarea in a better way -->

<!-- *********** Track Direct to EL-2, Entry to Search Area only via EL-2 *********** -->
    <block name="TrackToEL2">
      <set var="v_ctl_auto_throttle_cruise_throttle" value="V_CTL_AUTO_THROTTLE_MAX_CRUISE_THROTTLE"/> <!-- TODO see if this forced throttle stuff will work -->
      <go wp="VIAEL2" hmode="route"/>
     <!-- <go wp="EL2" hmode="route" throttle=".99" until ETA <5 sec then normal cruise again/>-->
    </block>

<!-- "Type 1" operation:
     an areascan with taking pictures of ground realtime anyyse and if joe found an accknolege signal given , autonomous drop and return.

     "Type 2"
     * There is a search phase and a rescue phase.
     ** Search means areascan gathering the imagery needed to pinpoint the location of lost Joe ("Type 1" operation)
     ** Rescue means the payload dropping phase. ("Type 1" operation)
     -->
     <!-- TODO: if defined TYPE2 then -->
<!--  
    <block name="determine_search_or_rescue_phase">
      <exception cond="InsideSurveyArea(WaypointX(WP_OUTBACKJOE), WaypointY(WP_OUTBACKJOE))" deroute="RescueJoe"/>
    </block>-->

<!-- ***********
See for calculations of camera values used
http://www.openuas.org/intranet/webapps/pmwiki/pmwiki.php?n=UAS.Targetcalc
Max Scanwidh at 120m is 180m
Mission scanwidh is 144m thus with a 20% overlap. Overlap depends on lots of factors,
best to perform many real life tests with the CAM
*********** -->

    <block name="SearchForJoe">
    <!--  was NavPolySurveySweepBackNum -->
      <exception cond="PolySurveySweepBackNum >= 1" deroute="ReturnToBase"/> <!-- ? TODO decide to search in reverse again on until battery < volts needed to return home? if nothing found, go back?-->
      <!-- <exception cond="FoundJoe" deroute="WaitForJugesDropApprovale"/> -->
      <!-- Parameters
      The orientation of the sweeps can ranges from north south to east west and
       any where in between (-90 <-> 90 degrees respectively).
       The side of the polygon the aircraft starts on (ex. north or south) is
       determined by the side of the polygon the entry point is located.
       call fun="InitializePolygonSurvey(WP_S1, NumOfCorners, SweepWidth, Orientation)"/> -->

       <!-- SweepWidth  max photo with at height - 20 pct overlap 180- etc-->
      <call fun="nav_survey_poly_osam_setup(WP_VIAEL2, 5, 144, 70)"/> <!-- TODO correct angle of how we want to search -->
      <call fun="nav_survey_poly_osam_run()"/>
    </block>

<!--WaitForJugesDropApproval if we do a Type 1 search otherwise it would be approved already Warning then never enter this block -->
<block name="WaitForJugesDropApproval">
<!-- circle with circle border already alligend with Drop align route, or maybe some better ideas... -->
<!-- TODO: if blocktime approval takes to long do what? -->
</block>

<!-- *********************************************************
     *********** Search Area Departure Procedure *************
     ***************************************************** -->

<!-- Todo add dashing speed if batter is above certain voltage level -->

<!-- Generic way to leave search area for both search and rescue missions -->
    <block name="ExitSearchArea">
    <!-- TODO Add max speed again -->
      <go wp="EL3"/>
    </block>

<!-- *********** Exit Search Area only via EL-3 *********** -->
    <block name="ExitSearchAreaViaEL3">
      <!-- TODO Add max speed again if not set -->
      <go wp="EL3"/>
    </block>

<!-- *********** Track Direct to EL-4 *********** -->
    <block name="GoToEL4">
     <!-- TODO Add max speed again if not set -->
      <go wp="EL4" hmode="route"/>
    </block>

<!-- ************ Track to Kingaroy Airport *********** -->
    <block name="ReturnToBase">
     <!-- TODO Add max speed again if not set -->
      <go wp="AIRFIELDHOME" hmode="route"/>
      <deroute block="InitiateLandingApproach"/>
    </block>

<!-- *********************************************************
     **************** Deliver the Payload ********************
     ***************************************************** -->

    <block name="RescueJoe">
      <!-- <go wp="VIAEL2" hmode="route"/>--> <!-- TODO maybe not needed -->
      <deroute block="drop"/>
    </block>
    
 <!--  AS REMINDER 
 extern unit_t nav_drop_compute_approach( uint8_t wp_target, uint8_t wp_start, float radius );
extern unit_t nav_drop_update_release( uint8_t wp_target );
extern unit_t nav_drop_shoot( void );
extern float nav_drop_trigger_delay, nav_drop_start_qdr;
extern bool_t compute_alignment(uint8_t w1, uint8_t w2, uint8_t start, uint8_t end, float d_before, float d_after);

#define NavDropComputeApproach(_target, _start, _radius) nav_drop_compute_approach(_target, _start, _radius)
#define NavDropUpdateRelease(_wp) nav_drop_update_release(_wp)
#define NavDropShoot() nav_drop_shoot()
#define NavDropCloseHatch() ({ ap_state->commands[COMMAND_HATCH] = MIN_PPRZ; })
#define NavDropAligned() Qdr(DegOfRad(nav_drop_qdr_aligned)) -->


<!-- *********** Drop Compute Approach *********** -->
    <block name="drop" strip_button="Drop">
 <!-- TODO set Height to minimum height AGL allowed by commitee ?60M -->   
 <!-- TODO determine what still is success and is fastest value for this 100  -->
      <set var="waypoints[WP_START].x" value="WaypointX(WP_OUTBACKJOE) + 100"/>
      <set var="waypoints[WP_START].y" value="WaypointY(WP_OUTBACKJOE) + 100"/>

      <set value="nav_drop_compute_approach(WP_OUTBACKJOE, WP_START, nav_radius)" var="unit"/><!-- TODO maybe adifferent radius to set than default nav radius, bigger? -->
      <circle radius="nav_radius" until="NavQdrCloseTo(DegOfRad(nav_drop_start_qdr)-15)" wp="BASELEG"/>
    </block>

<!-- *********** Align on release path *********** -->
    <block name="align">
 

 <!-- TODO set AIRSPEED_AT_RELEASE-->
 <!--TODO set HEIGHT to 60m -->
    <!-- After Payload is released, back via EL3 -->
     
      <exception cond="nav_drop_update_release(WP_OUTBACKJOE)" deroute="ExitSearchAreaViaEL3"/>
      <go approaching_time="nav_drop_trigger_delay" from="START" hmode="route" wp="RELEASE"/>
    </block>

<!-- *********** Release Payload *********** -->
    <block name="shoot">
    <!-- TODO maybe extend crowbreak 80%? for slowes possible speed? -->
     <!--   <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/> -->
      <!-- TODO is electrcal plane and almost there maybe stop proppelor from spinning for a few seconds -->
      <set value="NavDropShoot()" var="unit"/>
      <!-- TODO add maxspeed again -->
      <go from="RELEASE" hmode="route" wp="EL3"/>
      <!-- Maybe better not to close, more chance of delivery, TODO maybe even add a sensor to detect release if not try again -->
      <!-- <set value="NavDropCloseHatch" var="unit"/> -->

      <deroute block="ExitSearchAreaViaEL3"/><!-- Just To Make Sure -->
    </block>

<!-- *********************************************************
     ********************* Autolanding ***********************
     ***************************************************** -->

<!-- *********** Initiate landing *********** -->
<!--TODO better routing in combination with calced wind direction-->
    <block name="InitiateLandingApproach">
      <set var="v_ctl_auto_throttle_cruise_throttle" value="V_CTL_AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE"/><!-- TODO Test and deiscuss the stop dashing speedy flight here in this part of the block -->
    
<!--
To Waypoint runway align WP1 to WP2
then to WP touchdown
    <block name="Land Right AF-TD" strip_button="Land right (wp AF-TD)" strip_icon="land-right.png">
      <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
    <block name="Land Left AF-TD" strip_button="Land left (wp AF-TD)" strip_icon="land-left.png">
      <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
      <deroute block="land"/>
    </block>
 -->

    </block>

<!-- *********** Land *********** -->

    <block name="land">
      <call fun="nav_compute_baseleg(WP_AF, WP_TD, WP__BASELEG, nav_radius)"/>
      <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
      <!-- <set value="V_CTL_AUTO_THROTTLE_MIN_CRUISE_THROTTLE" var="v_ctl_auto_throttle_cruise_throttle"/> --> <!-- Good or Bad ?-->
      <circle radius="nav_radius" until="And(NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-10), 10 > fabs(GetPosAlt() - WaypointAlt(WP__BASELEG)))" wp="_BASELEG"/>
    </block>

    <block name="final">
      <!-- Crow position for breaking and less shallow landing slope and chance of stall n missed touchdown-->
      <!-- <set value="MAX_PPRZ" var="ap_state->commands[COMMAND_BRAKE]"/> -->
      <exception cond="ground_alt + 8 > GetPosAlt()" deroute="flare"/>
      <go from="AF" hmode="route" vmode="glide" wp="TD" alt="ground_alt"/>
    </block>

    <!-- TODO test differend Land strategy crowbreaking
   <block name="final">
      <set value="-MAX_PPRZ" var="ap_state->commands[COMMAND_BRAKE]"/>
      <go approaching_time="0" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>
    -->

    <block name="flare">
 <!--    <exception cond="NavDetectGround()" deroute="Holding point"/> -->
<!--  <exception cond="!nav_is_in_flight()" deroute="landed"/> --> <!-- todo maybe global? -->
<!--  <call fun="NavStartDetectGround()"/> -->
    <!-->  <set value="MAX_PPRZ" var="ap_state->commands[COMMAND_BRAKE]"/> TODO different value maybe-->
      <go approaching_time="0" from="AF" hmode="route" throttle="0.0" vmode="throttle" wp="TD"/>
       <!-- ?make sure manual throttle is still possible in case of manual laning override ?-->
      <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
    </block>

<!-- *********************************************************
     ********** Loss of Data Link – Rally Point **************
     ***************************************************** -->
<!--
TODO: get OBC2014Rules in 5.5.2.1 Loss of Data Link – Rally Point

* This flight mode must be activated if the data link is lost for 10 seconds.

* This flight mode, once activated, must return the aircraft directly to the
waypoint “Comms Hold” (Figure 1, Table 1) (no time limit for transit, but it
must be direct to the waypoint)

* and enter a loiter centred on that waypoint.
* After 2 minutes of loitering,

* if the data link has not been re-established, the aircraft must be programmed to return directly to
waypoint “Airfield Home” (Figure 1, Table 1), where the RC link
maybe re-established for a manual recovery. There is no time limit for
the transit, but it must be direct to the waypoint.

* On arriving at “Airfield Home”, the aircraft must enter a loiter centred
on that waypoint.

* If after 2 minutes, RC contact has not been re-established, an autopilot initiated and controlled flight termination
mode must be activated. A controlled flight termination mode may be
(but not limited to) an autonomous landing or entering the flight
termination mode (Section 5.6).
-->

    <block name="CommsHoldLoiter" strip_button="CommsHold" strip_icon="recenter.png">  <!-- TODO other ICON --> 
      <!-- TODO: maybe set a little lower speed ? max endurence speed? -->
      <set value="NOMINAL_AIRSPEED" var="v_ctl_auto_airspeed_setpoint"/>
      <!-- Rules 2014 state a loiter of maximum 2 minutes = 120seconds is allowed -->
      <exception cond="(stage_time > 120) || (datalinkloss_occurence_counter > 2)" deroute="AirfieldHomeLoiter"/>
      <!-- resume if datalink is regained-->   
      <!--TODO If the data link is regained prior to the conclusion of 2 minutes of loiter at
      Comms Hold the mission maybe continued otherwise any subsequent  TODO -->
      <exception cond="datalink_time < 10" deroute="TrackToEL2"/>      <!-- As soon as we have a link again Go EL2 and continue mission> -->
      <!-- TODO: better continue where we had our last telemerty still OK point if possible -->
      <!-- Since it arrived we must raise a counter by one. it's not alowed by rules to occur  more than twice, then we must move to airfieldhome -->
      <!-- TODO: set only after aircraft **arrived!** in the loiter not before the ETA < 1sec -->
       <set var="obcrulesdatalinklosscounter" value="obcrulesdatalinklosscounter+1"/>
      <!-- <while no link then -->
       <circle wp="COMMSHOLD" radius="nav_radius"/> <!-- TODO maybe bigger than default radius -->
    </block>

    <block name="AirfieldHomeLoiter">
      <exception cond="stage_time > 120" deroute="AirfieldHomeSoftlyDown"/>
      <circle wp="AIRFIELDHOME" radius="nav_radius*1.5"/><!-- 1.5 x  mean it will be a bit bigger circle -->
    </block>

<!-- circle smootly down -->
<!-- TODO: Make te routine correct it is NOT correct now -->
    <block name="AirfieldHomeSoftlyDown">
      <!--
      <for from="0" to="8" var="i">
        <circle radius="DEFAULT_CIRCLE_RADIUS - $i*10" wp="AIRFIELDHOME" until="NavCircleCount() > 1"/>
      </for>
      -->
      <deroute block="InitiateLandingApproach"/>
    </block>

<!-- TO make sure it somehow stop in case of lightplan mishap -->

<!--Engine Failure

Q:
 Procedure to be followed declared by the team in Deliverable 2.
 Follows from other rules, no working engine = decending till hit the ground but stll following regular flightplan, and if passing with no moterpower geofence rule will be adhered to also thus then switched to a forcedcrash
-->

<!--Below routes that are handy for testing only when in the field and performing several tests -->
<!--
    <block name="Oval 1-2" strip_button="Oval (wp 1-2)" strip_icon="oval.png">
      <oval p1="1" p2="2" radius="60"/>
    </block>
-->

<!-- WARNING: LOSS OF AIRFRAME if FTD is fully operational and tested in real life-->
<!--
    <block name="go too far">
      <go wp="TOOFAR"/>
      <circle wp="TOOFAR" radius="50"/>
     TODO: extra comman in case exeption does not trigger? like  <GO STDBY>
    </block>
-->

<!-- *********************************************************
     **************** Scrutineering Flight *******************
     ***************************************************** -->

<!-- As part of the scrutineering the Search and Rescue entrants of the UAV Challenge
Outback Rescue will be required to take off, track TST-1, TST-2, TST-3, TST-1... Until
requested to land. 

All emergency and failure requirements of the Challenge must be met, 

with the exception that for Loss of Data Link the procedure will be track direct
to “Airfield Home” and orbit for either a landing or regain of Data Link. -->

    <block name="Scrutineering Autonomy Start" strip_button="Square" strip_icon="path.png">
    <!--  <set value="0" var="ap_state->commands[COMMAND_CAMBER]"/> -->
   <!--   <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/> -->

      <!--first a little standby then onto the simple square -->
      <for from="0" to="2" var="i">
        <circle radius="nav_radius"  wp="STDBY" until="NavCircleCount() > 1"/>      <!--  <circle alt="WaypointAlt(WP_STDBY)" radius="nav_radius" wp="STDBY"/> -->
      </for>
    </block>

    <block name="Scrutineering Autonomy Triangle">
     <!-- TODO: while we are up there take some pictures anyhow :) -->
      <for from="0" to="3" var="i"> <!-- TODO: make it depending on battry energy left -->
        <go from="TST-3" hmode="route" wp="TST-1"/>
        <go from="TST-1" hmode="route" wp="TST-2"/>
        <go from="TST-2" hmode="route" wp="TST-3"/>
      </for>
    </block>

    <!-- Just make sure it somehow stops in case of flightplan mishap or no being able to take over -->
    <block key="a" name="Airfieldhome" strip_button="Airfieldhome" strip_icon="home.png">
      <!--<circle radius="nav_radius" wp="AIRFIELDHOME"/> -->
      <!-- TODO have two landing stratigy, one with circle down one with a streight line maybe a thir depending on measured windspeed -->
      <deroute block="InitiateLandingApproach"/>
    </block>

 <!-- For easy testing r -->
    <block name="Standby" strip_button="Standby" strip_icon="home.png">
   <!--   <set value="0" var="ap_state->commands[COMMAND_BRAKE]"/> -->
      <circle alt="WaypointAlt(WP_STDBY)" radius="nav_radius" wp="STDBY"/>
    </block>

<!-- *********************************************************
     ************ The routines used for the FTD **************
     ***************************************************** -->

    <block name="ForcedCrash">
      <!-- TODO Maybe ADD aditional exception with 2 sec timer here just to be sure to avoid position GPS spikes or some other jitter issues -->
      <!-- <exception cond="Or(! InsideMissionBoundary(estimator_x, estimator_y), estimator_z > ground_alt + 921)"> --> 
      <!-- TODO use Baro QNH Height -->
      
      <!-- <set value="MAX_PPRZ" var="ap_state->commands[COMMAND_FORCECRASH]"/> -->
      <!--</exception> -->

      <go wp="STDBY" vmode="throttle" throttle="0"/> <!-- todo add a dynamic TDFORCEDCRASH point so to notify and have it in the log  -->
    </block>
<!--
    <block name="TestHatch">
      <set value="NavDropCloseHatch()" var="unit"/>
      <set value="NavDropShoot()" var="unit"/>
      <set value="NavDropCloseHatch()" var="unit"/>
      <set value="NavDropShoot()" var="unit"/>
      <set value="NavDropCloseHatch()" var="unit"/>
      <set value="NavDropShoot()" var="unit"/>
    </block>
-->
  </blocks>
</flight_plan>

