<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="GeniusDD">

	<firmware name="rotorcraft">
		<target name="ap" board="lisa_s_1.0">
			<module name="radio_control" type="ppm">
				<configure name="RADIO_CONTROL_PPM_PIN" value="SERVO6" />
			</module>
		</target>

		<module name="actuators" type="pwm">
			<define name="TIM5_SERVO_HZ" value="40" />
			<define name="SERVO_HZ" value="40" />
			<define name="USE_SERVOS_1AND2" />
		</module>

		<configure name="USE_MAGNETOMETER" value="0" />

		<module name="telemetry" type="transparent">
			<configure name="MODEM_BAUD" value="B115200" />
			<configure name="MODEM_PORT" value="UART1" />
		</module>

		<module name="imu" type="lisa_s_v1.0" />
		<module name="gps" type="ublox" />
		<module name="stabilization" type="int_quat" />
		<module name="ahrs" type="int_cmpl_quat" />
		<module name="ins" />
	</firmware>

	<modules main_freq="512">
		<!--<load name="geo_mag.xml"/> -->
		<load name="air_data.xml" />
		<load name="gps_ubx_ucenter.xml" />
		<!-- <load name="heli_swashplate_mixing.xml" /> -->
		<!-- <load name="heli_throttle_curve.xml" /> -->
	</modules>

	<servos driver="Pwm">
		<!-- Throttle range OK -->
		<servo name="S_THROTTLE" no="1" min="1000" neutral="1130" max="1900" />
		<servo name="BACK" no="5" min="2090" neutral="1500" max="1000" />
		<servo name="RIGHTFRONT" no="4" min="2040" neutral="1550" max="1270" />
		<servo name="LEFTFRONT" no="0" min="2010" neutral="1450" max="880" />
		<servo name="TAIL" no="2" min="0" neutral="0" max="3500" />
	</servos>

	<commands>
		<axis name="THRUST" failsafe_value="0" />
		<axis name="ROLL" failsafe_value="0" />
		<axis name="PITCH" failsafe_value="0" />
		<axis name="YAW" failsafe_value="0" />
		<axis name="FMODE" failsafe_value="-9600" />
	</commands>

	<rc_commands>
		<set command="THRUST" value="@THROTTLE" />
		<set command="ROLL" value="@ROLL" />
		<set command="PITCH" value="@PITCH" />
		<set command="YAW" value="@YAW" />
		<set command="FMODE" value="-9600" />
	</rc_commands>

	<section name="MIXING" prefix="SW_MIXING_">
		<define name="TYPE" value="HR120" />
		<define name="TRIM_ROLL" value="0" />
		<define name="TRIM_PITCH" value="0" />
		<define name="TRIM_COLL" value="0" />
	</section>

	<command_laws>
		<!-- <call fun="throttle_curve_run(true, values)" /> -->
		<!-- <call fun="swashplate_mixing_run(values)" /> -->
		<set servo="S_THROTTLE" value="@PITCH" />
		<set servo="BACK" value="@ROLL" />
		<set servo="RIGHTFRONT" value="@YAW" />
		<set servo="LEFTFRONT" value="@PITCH" />
		<set servo="TAIL" value="1000" />
	</command_laws>

	<!-- <command_laws> <set servo="BACK" value="@PITCH" /> <set servo="RIGHTFRONT" 
		value="@ROLL" /> <set servo="LEFTFRONT" value="@PITCH" /> <set servo="TAIL" 
		value="@YAW" /> </command_laws> -->


	<!--<heli_curves> <curve throttle="0,4800,7200,8400,9600" collective="-1000,750,2500,4250,6000" 
		/> <curve throttle="4000" collective="4000" /> </heli_curves> -->


	<section name="IMU" prefix="IMU_">
		<define name="ACCEL_X_NEUTRAL" value="11" />
		<define name="ACCEL_Y_NEUTRAL" value="11" />
		<define name="ACCEL_Z_NEUTRAL" value="-25" />

		<!-- replace this with your own calibration -->

		<define name="BODY_TO_IMU_PHI" value="0" unit="deg" />
		<define name="BODY_TO_IMU_THETA" value="90.0" unit="deg" />
		<define name="BODY_TO_IMU_PSI" value="0" unit="deg" />
	</section>

	<section name="AHRS" prefix="AHRS_">
		<define name="H_X" value="0.3770441" />
		<define name="H_Y" value="0.0193986" />
		<define name="H_Z" value="0.9259921" />
	</section>

	<section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
		<!-- setpoints -->
		<define name="SP_MAX_P" unit="deg/s" value="280" />
		<define name="SP_MAX_Q" unit="deg/s" value="280" />
		<define name="SP_MAX_R" unit="deg/s" value="140" />
		<define name="DEADBAND_P" value="20" />
		<define name="DEADBAND_Q" value="20" />
		<define name="DEADBAND_R" value="200" />

		<!-- feedback -->
		<define name="GAIN_P" value="400" />
		<define name="GAIN_Q" value="400" />
		<define name="GAIN_R" value="350" />

		<define name="IGAIN_P" value="75" />
		<define name="IGAIN_Q" value="75" />
		<define name="IGAIN_R" value="50" />
	</section>

	<section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
		<!-- setpoints -->
		<define name="SP_MAX_PHI" value="65." unit="deg" />
		<define name="SP_MAX_THETA" value="65." unit="deg" />
		<define name="SP_MAX_R" value="250." unit="deg/s" />
		<define name="DEADBAND_R" value="200" />

		<!-- reference -->
		<define name="REF_OMEGA_P" value="800" unit="deg/s" />
		<define name="REF_ZETA_P" value="0.85" />
		<define name="REF_MAX_P" value="300." unit="deg/s" />
		<define name="REF_MAX_PDOT" value="RadOfDeg(7000.)" />
		<define name="REF_OMEGA_Q" value="800" unit="deg/s" />
		<define name="REF_ZETA_Q" value="0.85" />
		<define name="REF_MAX_Q" value="300." unit="deg/s" />
		<define name="REF_MAX_QDOT" value="RadOfDeg(7000.)" />
		<define name="REF_OMEGA_R" value="500" unit="deg/s" />
		<define name="REF_ZETA_R" value="0.85" />
		<define name="REF_MAX_R" value="180." unit="deg/s" />
		<define name="REF_MAX_RDOT" value="RadOfDeg(1800.)" />

		<!-- feedback -->
		<define name="PHI_PGAIN" value="3003" />
		<define name="PHI_DGAIN" value="333" />
		<define name="PHI_IGAIN" value="200" />
		<define name="THETA_PGAIN" value="2172" />
		<define name="THETA_DGAIN" value="329" />
		<define name="THETA_IGAIN" value="200" />
		<define name="PSI_PGAIN" value="2074" />
		<define name="PSI_DGAIN" value="1479" />
		<define name="PSI_IGAIN" value="10" />

		<!-- feedforward -->
		<define name="PHI_DDGAIN" value=" 200" />
		<define name="THETA_DDGAIN" value=" 200" />
		<define name="PSI_DDGAIN" value=" 200" />
	</section>

	<section name="GUIDANCE_V" prefix="GUIDANCE_V_">
		<define name="HOVER_KP" value="150" />
		<define name="HOVER_KD" value="80" />
		<define name="HOVER_KI" value="20" />
		<define name="NOMINAL_HOVER_THROTTLE" value="0.5" />
		<define name="ADAPT_THROTTLE_ENABLED" value="TRUE" />
	</section>

	<section name="GUIDANCE_H" prefix="GUIDANCE_H_">
		<define name="MAX_BANK" value="35" unit="deg" />
		<define name="USE_SPEED_REF" value="TRUE" />
		<define name="PGAIN" value="50" />
		<define name="DGAIN" value="100" />
		<define name="AGAIN" value="70" />
		<define name="IGAIN" value="20" />
	</section>

	<section name="AUTOPILOT">
		<define name="MODE_MANUAL" value="AP_MODE_RC_DIRECT" />
		<define name="MODE_AUTO1" value="AP_MODE_RC_DIRECT" />
		<define name="MODE_AUTO2" value="AP_MODE_RC_DIRECT" />


		<define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING" value="0" />
		<define name="AUTOPILOT_DISABLE_AHRS_KILL" />

		<define name="USE_THROTTLE_FOR_MOTOR_ARMING" value="TRUE" />
		<define name="NO_RC_THRUST_LIMIT" value="TRUE" />
	</section>

	<section name="BAT">
		<define name="MILLIAMP_AT_FULL_THROTTLE" value="14000" unit="mA" />
		<define name="CATASTROPHIC_BAT_LEVEL" value="2.8" unit="V" />
		<define name="CRITIC_BAT_LEVEL" value="3.0" unit="V" />
		<define name="LOW_BAT_LEVEL" value="3.2" unit="V" />
		<define name="MAX_BAT_LEVEL" value="4.2" unit="V" />
	</section>

</airframe>
