<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<!-- /home/microuav/paparazzi/sw/tools/bluegiga_usb_dongle/bluegiga_usb_driver 
	/dev/ttyACM2 00:07:80:2d:d6:d9 4242 4252 -->

<airframe name="mini_delftacopter">

	<firmware name="rotorcraft">
		<!-- <define name="RADIO_CONTROL_NB_CHANNEL" value="6" /> -->
		<target name="ap" board="lisa_s_1.0">
			<module name="radio_control" type="ppm">
				<configure name="RADIO_CONTROL_PPM_PIN" value="SERVO6" />
			</module>
			<configure name="AHRS_PROPAGATE_FREQUENCY" value="500" />
		</target>
		<define name="AHRS_GRAVITY_HEURISTIC_FACTOR" value="0" />

		<module name="actuators" type="pwm">
			<define name="TIM5_SERVO_HZ" value="2000" />
			<define name="SERVO_HZ" value="300" />
			<define name="USE_SERVOS_1AND2" />
		</module>

		<configure name="USE_MAGNETOMETER" value="1" />
		<module name="telemetry" type="transparent">
			<configure name="MODEM_BAUD" value="B115200" />
			<configure name="MODEM_PORT" value="UART1" />
		</module>
		<!-- Comment the previous line and uncomment the following one if you need 
			to use the debug serial interface for telemetry. -->
		<!--module name="telemetry" type="transparent"/ -->
		<module name="imu" type="lisa_s_v1.0" />
		<module name="ahrs" type="int_cmpl_quat" />
		<module name="ins" />
	</firmware>

	<modules main_freq="512">
		<load name="air_data.xml" />
		<load name="gps_ubx_ucenter.xml" />
		<load name="heli_swashplate_mixing.xml" />
		<load name="heli_throttle_curve.xml" />  
		<module name="ins"/>
	</modules>

	<servos driver="Pwm">
		<!-- Throttle range OK -->
		<servo name="THROTTLE" no="1" min="1200" neutral="1230" max="1800" />
		<servo name="FRONT" no="5" min="1700" neutral="1300" max="1000" />
		<servo name="RIGHTBACK" no="4" min="1850" neutral="1450" max="1100" />
		<servo name="LEFTBACK" no="0" min="1850" neutral="1450" max="1100" />
		<servo name="TAIL" no="2" min="0" neutral="0" max="3500" />
	</servos>

	<commands>
		<axis name="THRUST" failsafe_value="0" />
		<axis name="ROLL" failsafe_value="0" />
		<axis name="PITCH" failsafe_value="0" />
		<axis name="YAW" failsafe_value="0" />
		<axis name="FMODE" failsafe_value="-9600" />
	</commands>

	<rc_commands>
		<set command="THRUST" value="@THROTTLE" />
		<set command="ROLL" value="@ROLL" />
		<set command="PITCH" value="@PITCH" />
		<set command="YAW" value="@THROTTLE" />
		<set command="FMODE" value="-9600" />
	</rc_commands>

	<section name="MIXING" prefix="SW_MIXING_">
		<define name="TYPE" value="H120" />
		<define name="TRIM_ROLL" value="0" />
		<define name="TRIM_PITCH" value="0" />
		<define name="TRIM_COLL" value="0" />
	</section>

	<command_laws>
		<call fun="throttle_curve_run(true,values)" />
		<call fun="swashplate_mixing_run(values)" />
		<set servo="THROTTLE" value="@THRUST" />
		<set servo="FRONT" value="swashplate_mixing.commands[SW_FRONT]" />
		<set servo="RIGHTBACK" value="swashplate_mixing.commands[SW_RIGHTBACK]" />
		<set servo="LEFTBACK" value="swashplate_mixing.commands[SW_LEFTBACK]" />
		<set servo="TAIL" value="@YAW + throttle_curve.throttle*2800/7000" />
	</command_laws>

	<heli_curves>
		<curve throttle="0,4800,7200,8400,9600" collective="-1000,750,2500,4250,6000" />		
	</heli_curves>

	<section name="IMU" prefix="IMU_">
		<define name="ACCEL_X_NEUTRAL" value="0" />
		<define name="ACCEL_Y_NEUTRAL" value="0" />
		<define name="ACCEL_Z_NEUTRAL" value="0" />
	</section>



	<section name="BAT">
		<define name="MILLIAMP_AT_FULL_THROTTLE" value="14000" />
		<define name="CATASTROPHIC_BAT_LEVEL" value="2.8" unit="V" />
		<define name="CRITIC_BAT_LEVEL" value="3.0" unit="V" />
		<define name="LOW_BAT_LEVEL" value="3.2" unit="V" />
		<define name="MAX_BAT_LEVEL" value="4.1" unit="V" />
	</section>

</airframe>
