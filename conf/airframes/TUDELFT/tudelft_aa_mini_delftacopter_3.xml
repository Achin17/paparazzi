<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="heli450">

	<firmware name="rotorcraft">
		<target name="ap" board="lisa_s_1.0">
			<module name="radio_control" type="ppm">
				<configure name="RADIO_CONTROL_PPM_PIN" value="SERVO6" />
			</module>
		</target>

		<module name="actuators" type="pwm">
			<define name="TIM5_SERVO_HZ" value="40" />
			<define name="SERVO_HZ" value="40" />
			<define name="USE_SERVOS_1AND2" />
		</module>

		<configure name="USE_MAGNETOMETER" value="0" />

		<module name="telemetry" type="transparent">
			<configure name="MODEM_BAUD" value="B115200" />
			<configure name="MODEM_PORT" value="UART1" />
		</module>

		<module name="imu" type="lisa_s_v1.0" />
		<module name="gps" type="ublox" />
		<module name="stabilization" type="int_quat" />
		<module name="ahrs" type="int_cmpl_quat" />
		<module name="ins" />
	</firmware>

	<modules main_freq="512">
		<!--<load name="geo_mag.xml"/> -->
		<load name="air_data.xml" />
		<load name="gps_ubx_ucenter.xml" />
		<load name="heli_swashplate_mixing.xml" /> 
		<load name="heli_throttle_curve.xml" /> 
	</modules>

	<servos driver="Pwm">
		<!-- Throttle range OK -->
		<servo name="S_THROTTLE" no="1" min="1000" neutral="1130" max="1900" />
		<servo name="BACK" no="5" min="2090" neutral="1500" max="1000" />
		<servo name="RIGHTFRONT" no="4" min="2040" neutral="1550" max="1270" />
		<servo name="LEFTFRONT" no="0" min="2010" neutral="1450" max="880" />
		<servo name="TAIL" no="2" min="0" neutral="0" max="3500" />
	</servos>

	<commands>
		<axis name="THRUST" failsafe_value="0" />
		<axis name="ROLL" failsafe_value="0" />
		<axis name="PITCH" failsafe_value="0" />
		<axis name="YAW" failsafe_value="0" />
		<axis name="FMODE" failsafe_value="0" />
	</commands>

	<rc_commands>
		<set command="THRUST" value="@THROTTLE" />
		<set command="ROLL" value="@ROLL" />
		<set command="PITCH" value="@PITCH" />
		<set command="YAW" value="@YAW" />
		<set command="FMODE" value="@MODE" />
	</rc_commands>

	<section name="MIXING" prefix="SW_MIXING_">
		<!-- front left (CW), front right (CCW), back right (CW), back left (CCW) -->
		<define name="TYPE" value="HR120" />
		<define name="TRIM_ROLL" value="0" />
		<define name="TRIM_PITCH" value="0" />
		<define name="TRIM_COLL" value="0" />
	</section>

	<command_laws>
		<call fun="throttle_curve_run(autopilot_get_motors_on(), values)" />
		<call fun="swashplate_mixing_run(values)" />
		<set servo="S_THROTTLE" value="throttle_curve.throttle" />
		<set servo="BACK" value="swashplate_mixing.commands[SW_BACK]" />
		<set servo="LEFTFRONT" value="swashplate_mixing.commands[SW_LEFTFRONT]" />
		<set servo="RIGHTFRONT" value="swashplate_mixing.commands[SW_RIGHTFRONT]" />
		<set servo="TAIL" value="@YAW + throttle_curve.throttle*2800/7000" />
	</command_laws>

	<heli_curves>
		<curve throttle="0,9600" collective="1500,6000" />
	</heli_curves>

	<section name="MISC">
		<define name="NAV_CLIMB_VSPEED" value="2.5" />
		<define name="NAV_DESCEND_VSPEED" value="-1.0" />
		<define name="NO_RC_THRUST_LIMIT" value="TRUE" />
	</section>

	<section name="IMU" prefix="IMU_">
		<define name="ACCEL_X_NEUTRAL" value="11" />
		<define name="ACCEL_Y_NEUTRAL" value="11" />
		<define name="ACCEL_Z_NEUTRAL" value="-25" />

		<!-- replace this with your own calibration -->
		<define name="MAG_X_NEUTRAL" value="14" />
		<define name="MAG_Y_NEUTRAL" value="116" />
		<define name="MAG_Z_NEUTRAL" value="119" />
		<define name="MAG_X_SENS" value="5.09245681612" integer="16" />
		<define name="MAG_Y_SENS" value="5.29702744632" integer="16" />
		<define name="MAG_Z_SENS" value="5.65287938992" integer="16" />

		<define name="BODY_TO_IMU_PHI" value="0." unit="deg" />
		<define name="BODY_TO_IMU_THETA" value="90.0" unit="deg" />
		<define name="BODY_TO_IMU_PSI" value="0." unit="deg" />
	</section>

	<section name="AHRS" prefix="AHRS_">
		<!--This airframe vibrates a lot, which causes accel measurements in excess 
			of 1g continuously -->
		<define name="GRAVITY_HEURISTIC_FACTOR" value="0" />

		<!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
		<define name="H_X" value="0.3770441" />
		<define name="H_Y" value="0.0193986" />
		<define name="H_Z" value="0.9259921" />
	</section>

	<section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
		<!-- setpoints -->
		<define name="SP_MAX_P" unit="deg/s" value="280" />
		<define name="SP_MAX_Q" unit="deg/s" value="280" />
		<define name="SP_MAX_R" unit="deg/s" value="140" />
		<define name="DEADBAND_P" value="20" />
		<define name="DEADBAND_Q" value="20" />
		<define name="DEADBAND_R" value="200" />

		<!-- feedback -->
		<define name="GAIN_P" value="800" /> 
		<define name="GAIN_Q" value="800" />
		<define name="GAIN_R" value="700" />

		<define name="IGAIN_P" value="240" />
		<define name="IGAIN_Q" value="240" />
		<define name="IGAIN_R" value="160" />
	</section>


	<section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
		<!-- setpoints -->
		<define name="SP_MAX_PHI" value="65." unit="deg" />
		<define name="SP_MAX_THETA" value="65." unit="deg" />
		<define name="SP_MAX_R" value="250." unit="deg/s" />
		<define name="DEADBAND_R" value="200" />

		<!-- reference -->
		<define name="REF_OMEGA_P" value="800" unit="deg/s" />
		<define name="REF_ZETA_P" value="0.85" />
		<define name="REF_MAX_P" value="300." unit="deg/s" />
		<define name="REF_MAX_PDOT" value="RadOfDeg(7000.)" />
		<define name="REF_OMEGA_Q" value="800" unit="deg/s" />
		<define name="REF_ZETA_Q" value="0.85" />
		<define name="REF_MAX_Q" value="300." unit="deg/s" />
		<define name="REF_MAX_QDOT" value="RadOfDeg(7000.)" />
		<define name="REF_OMEGA_R" value="500" unit="deg/s" />
		<define name="REF_ZETA_R" value="0.85" />
		<define name="REF_MAX_R" value="180." unit="deg/s" />
		<define name="REF_MAX_RDOT" value="RadOfDeg(1800.)" />

		<!-- feedback -->
		<define name="PHI_PGAIN" value="900" />
		<define name="PHI_DGAIN" value="200" />
		<define name="PHI_IGAIN" value="200" />
		<define name="THETA_PGAIN" value="900" />
		<define name="THETA_DGAIN" value="200" />
		<define name="THETA_IGAIN" value="200" />
		<define name="PSI_PGAIN" value="900" />
		<define name="PSI_DGAIN" value="200" />
		<define name="PSI_IGAIN" value="10" />

		<!-- feedforward -->
		<define name="PHI_DDGAIN" value=" 200" />
		<define name="THETA_DDGAIN" value=" 200" />
		<define name="PSI_DDGAIN" value=" 200" />
	</section>

	<section name="GUIDANCE_V" prefix="GUIDANCE_V_">
		<define name="HOVER_KP" value="150" />
		<define name="HOVER_KD" value="80" />
		<define name="HOVER_KI" value="20" />
		<define name="NOMINAL_HOVER_THROTTLE" value="0.5" />
		<define name="ADAPT_THROTTLE_ENABLED" value="TRUE" />
	</section>

	<section name="GUIDANCE_H" prefix="GUIDANCE_H_">
		<define name="MAX_BANK" value="35" unit="deg" />
		<define name="USE_SPEED_REF" value="TRUE" />
		<define name="PGAIN" value="50" />
		<define name="DGAIN" value="100" />
		<define name="AGAIN" value="70" />
		<define name="IGAIN" value="20" />
	</section>

	<section name="AUTOPILOT">
		<define name="MODE_MANUAL" value="AP_MODE_RC_DIRECT" />
		<define name="MODE_AUTO1" value="AP_MODE_RC_DIRECT" />
		<define name="MODE_AUTO2" value="AP_MODE_RC_DIRECT" />
	</section>

	<section name="BAT">
		<define name="CATASTROPHIC_BAT_LEVEL" value="2.8" unit="V" />
		<define name="CRITIC_BAT_LEVEL" value="3.0" unit="V" />
		<define name="LOW_BAT_LEVEL" value="3.2" unit="V" />
		<define name="MAX_BAT_LEVEL" value="4.2" unit="V" />
	</section>

</airframe>
