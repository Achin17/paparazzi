<!DOCTYPE airframe SYSTEM "../airframe.dtd">
<!-- 
 The Airframe for the GGM MK1
 
 To upload new AP see:
 https://wiki.paparazziuav.org/wiki/Pixhawk
 
 + AP_Board:    Pixhawk 2.4
 + IMU:         L3GD20 +  LSM303D + MPU6000 + external HMC58XX
 + Actuators:   PWM motor controllers 8
 
 + RC:          DSMX over air, SBus out, later 433LR
 + TELEMETRY:   XBEE 2.4Ghz
 
 NOTES:
 + GPS:         For validation only uBlox M8N http://wiki.paparazziuav.org/wiki/Subsystem/gps
 + Power from specific 
 + Parachute on landing and RC loss
 
 MK1
 2x Side mounnted motors, 2x ESC, Yaw quick n dirty same out, one ESC 1100 till 1499 range other 1501 to 1900
 Different direction flow.
 
 Rotor rotation directions looking from the top
 For YAW1/2 90 deg motors to front of Prop:

FRONT_LEFT_UPPER -> CCW
FRONT_LEFT_LOWER -> CW
    
YAW_1 -> CW
YAW_2 -> CW
    
FRONT_RIGHT_UPPER -> CW
FRONT_RIGHT_LOWER -> CCW
        
TAIL_RIGHT -> CCW
TAIL_LEFT -> CW
  
-->
<airframe name="GGM">
  <firmware name="rotorcraft">

    <target name="ap" board="px4fmu_2.4" />
    <define name="AUTOPILOT_DISABLE_AHRS_KILL"/> 
       
    <define name="ACTUATORS_PWM_NB" value="8" />
    
    <define name="USE_PWM5" value="1" />
    <define name="USE_PWM6" value="1" />
    <define name="USE_PWM7" value="1" />
    <define name="USE_PWM8" value="1" />

    <!-- <define name="ADC_CHANNEL_VSUPPLY" value="ADC_1"/>-->
    
    <define name="BAT_CHECKER_DELAY" value="80" />
    <define name="CATASTROPHIC_BATTERY_KILL_DELAY" value="10000" />

    <!-- <module name="telemetry" type="transparent_usb" />-->
    <module name="telemetry" type="transparent" />

    <module name="imu" type="px4fmu_v2.4"/>
    
    <module name="gps" type="ublox">
      <configure name="GPS_BAUD" value="B57600" />
    </module>
    
    <module name="gps" type="ubx_ucenter" />
    <module name="stabilization" type="int_quat" />
    <!-- Saved the best for later.. ;) <module name="stabilization" type="indi_simple" /> -->
    
    <module name="ahrs" type="int_cmpl_quat" >
      <define name="AHRS_ICQ_IMU_ID" value="IMU_PX4_ID" />             <!-- This using the lsm303 and l3g -->
      <define name="AHRS_ICQ_MAG_ID" value="MAG_HMC58XX_SENDER_ID" />  <!-- When using the external hmc-->
      <configure name="USE_MAGNETOMETER" value="TRUE" />
      <define name="AHRS_USE_GPS_HEADING" value="FALSE"/>
    </module>
    
    <module name="ins" type="extended" />
    
    <!-- TODO: add -->
    <module name="current_sensor">
      <configure name="ADC_CURRENT_SENSOR" value="ADC_3" />
    </module>
    
    <module name="intermcu" type="uart">
      <configure name="INTERMCU_PORT" value="UART6" />
      <configure name="INTERMCU_BAUD" value="B1500000" /> <!-- This is only during first 10s start up, afterwards it is set to 230400-->
    </module>
      <define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING" value="1" />
  </firmware>
  
  <!-- FWB part in separate firmware -->
  <firmware name="rotorcraft">
    <target name="fbw" board="px4io_2.4" />
    <define name="ACTUATORS_PWM_NB" value="8" />
        
    <define name="USE_PWM5" value="1" />
    <define name="USE_PWM6" value="1" />
    <define name="USE_PWM7" value="1" />
    <define name="USE_PWM8" value="1" />
    
    <module name="motor_mixing" />
    
    <!--define name="AUTOPILOT_DISABLE_AHRS_KILL"/-->
    
    <define name="FBW_MODE_AUTO_ONLY" value="TRUE"/>
    
    <module name="radio_control" type="sbus">
      <configure name="SBUS_PORT" value="UART3"/>
       <define name="RADIO_CONTROL_NB_CHANNEL" value="8"/>
      <define name="RADIO_FBW_MODE" value="RADIO_MODE"/>
      <define name="RADIO_KILL_SWITCH" value="RADIO_KILL"/>
      <define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING" value="1" />
    </module>
      
    <module name="actuators" type="pwm">
      <define name="SERVO_HZ" value="40" />
    </module>
    
    <define name="RC_LOST_FBW_MODE" value="FBW_MODE_FAILSAFE" />
    <define name="RC_LOST_IN_AUTO_FBW_MODE" value="FBW_MODE_AUTO" />
    <define name="AP_LOST_FBW_MODE" value="FBW_MODE_FAILSAFE" /><!-- or FBW_MODE_MANUAL -->

    <define name="INTERMCU_LOST_CNT" value="100" />
    <module name="intermcu" type="uart">
      <configure name="INTERMCU_PORT" value="UART2" />
      <configure name="INTERMCU_BAUD" value="B1500000" />
    </module>
  </firmware>
  
  <modules main_freq="512">
   <module name="px4_flash">
      <configure name="PX4IO_UART" value="uart6"/>
    </module>
    <module name="geo_mag" />
    <module name="air_data" />
    <module name="send_imu_mag_current" /><!-- Disable after MKFinal -->
    <module name="mag" type="hmc58xx">
      <configure name="MAG_HMC58XX_I2C_DEV" value="i2c1"/>
      <define name="MODULE_HMC58XX_UPDATE_AHRS" value="TRUE"/>
      <define name="HMC58XX_CHAN_X" value="1"/>
      <define name="HMC58XX_CHAN_Y" value="0"/>
      <define name="HMC58XX_CHAN_Z" value="2"/>
      <define name="HMC58XX_CHAN_X_SIGN" value="-"/>
      <define name="HMC58XX_CHAN_Y_SIGN" value="+"/>
      <define name="HMC58XX_CHAN_Z_SIGN" value="+"/>
    </module>
  </modules>

  <section name="MISC">
    <define name="MilliAmpereOfAdc(adc)" value="((float)adc) * (3.3f / 4096.0f) * (90.0f / 5.0f)" />
  </section>
  
  <section name="IMU" prefix="IMU_">
    <!-- replace this with your own calibration -->
    <define name="ACCEL_X_NEUTRAL" value="0"/>
    <define name="ACCEL_Y_NEUTRAL" value="0"/>
    <define name="ACCEL_Z_NEUTRAL" value="0"/>
    <define name="ACCEL_X_SENS" value="8.0" integer="16"/>
    <define name="ACCEL_Y_SENS" value="8.0" integer="16"/>
    <define name="ACCEL_Z_SENS" value="8.0" integer="16"/>
   
    <!-- place your MAG calibration here -->
    <!-- WARNING: NOT advised to fly with the default values... -->
    <!--Calibrate outside, use: sw/tools/calibration/calibrate.py -s MAG var/logs/???.data -vp -->
    <define name="MAG_X_NEUTRAL" value="0"/>
    <define name="MAG_Y_NEUTRAL" value="0"/>
    <define name="MAG_Z_NEUTRAL" value="0"/>
    <define name="MAG_X_SENS" value="4.0" integer="16"/>
    <define name="MAG_Y_SENS" value="4.0" integer="16"/>
    <define name="MAG_Z_SENS" value="4.0" integer="16"/>
    
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="180." unit="deg"/>
  </section>
     
  <!--  ******* START ************* --> 
  <rc_commands>
    <set command="THRUST" value="@THROTTLE" />
    <set command="ROLL"   value="@ROLL" />
    <set command="PITCH"  value="@PITCH" />
    <set command="YAW"    value="@YAW" />
  </rc_commands>
  
  <commands>
    <axis name="PITCH"  failsafe_value="0"/>
    <axis name="ROLL"   failsafe_value="0"/>
    <axis name="YAW"    failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>
  
  <servos driver="Default"><!-- set pulsespeed for reliability not agility -->
    <!-- CW 1,2,3,4,5,6,7,8 Plus additional Yaw 2x -->
        
    <servo name="FRONT_LEFT_UPPER" no="0"  min="1000" neutral="1200" max="1950" />
    <servo name="FRONT_LEFT_LOWER" no="1"  min="1000" neutral="1200" max="1950" />
    
    <servo name="YAW_1" no="2"             min="1000" neutral="1200" max="1950" />  
    <servo name="YAW_2" no="3"             min="1000" neutral="1200" max="1950" />
    
    <servo name="FRONT_RIGHT_UPPER" no="4" min="1000" neutral="1200" max="1950" />
    <servo name="FRONT_RIGHT_LOWER" no="5" min="1000" neutral="1200" max="1950" />
        
    <servo name="TAIL_RIGHT" no="6"        min="1000" neutral="1200" max="1950" />  
    <servo name="TAIL_LEFT" no="7"         min="1000" neutral="1200" max="1950" />
   
    <!--  Via SBUS servo Extender Possible--> 
    <!-- TODO: setting these defines, RC non worky worky anymore, weird-->  
   <!--   <servo name="SPECIAL1" no="9" min="1100" neutral="1120" max="1900" />
    <servo name="SPECIAL2" no="10" min="1100" neutral="1120" max="1900" />
    <servo name="SPECIAL3" no="11" min="1100" neutral="1120" max="1900" />
    <servo name="SPECIAL4" no="12" min="1100" neutral="1120" max="1900" /> -->
          
  </servos>
  
  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    
    <define name="NB_MOTOR" value="6"/>
    <define name="SCALE" value="256"/>

    <!--  First calculated values, to be precised -->
    <define name="THRUST_COEF" value="{ 256, 256, 256, 256, 256, 256 }"/>
    <define name="ROLL_COEF"   value="{ 256, 256, -256, -256, -73, 73 }"/>
    <define name="PITCH_COEF"  value="{ 57, 57, 57, 57, -205, -205 }"/>
    <define name="YAW_COEF"    value="{ 256, -256, -256, 256, 256, -256 }"/>
  
  </section>
  
  <command_laws>
    <!-- ** Left and Right as seen from top standing at tail ** -->
    
    <!-- EXP <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>-->  
    <call fun="motor_mixing_run(fbw_motors_on,FALSE,values)" /><!-- TOdo REfactor fbw_motors_on -> fbw_get_motors_on() -->
    <let var="th_hold"          value="MoreThan(RadioControlValues(RADIO_KILL), -4800)"/>
    <!--  FRONT LEFTSIDE -->   
    <set servo="FRONT_LEFT_UPPER" value="motor_mixing.commands[0]" /><!-- MOTOR_FRONT_LEFT_UPPER -->
    <set servo="FRONT_LEFT_LOWER" value="motor_mixing.commands[1]" /><!-- MOTOR_FRONT_LEFT_LOWER -->
    
    <!--  YAW--> 
    <set servo="YAW_1" value="($th_hold ? (LessThan(@YAW, 0)? 0 : @YAW) : -MAX_PPRZ)" /><!-- MOTOR_YAW_1 -->
    <set servo="YAW_2" value="($th_hold ? (LessThan(-@YAW, 0)? 0 : -@YAW) : -MAX_PPRZ)" /><!-- MOTOR_YAW_2 -->
    
    <!--  FRONT RIGHTSIDE --> 
    <set servo="FRONT_RIGHT_UPPER" value="motor_mixing.commands[2]" /><!-- MOTOR_FRONT_RIGHT_UPPER -->
    <set servo="FRONT_RIGHT_LOWER" value="motor_mixing.commands[3]" /><!-- MOTOR_FRONT_RIGHT_LOWER -->
    
    <!--  TAIL RIGHTSIDE--> 
    <set servo="TAIL_RIGHT" value="motor_mixing.commands[4]" /><!-- MOTOR_TAIL_RIGHT -->
    
    <!-- TAIL LEFTSIDE --> 
    <set servo="TAIL_LEFT" value="motor_mixing.commands[5]" /><!-- MOTOR_TAIL_LEFT -->

  </command_laws>
  
  <!-- END -->

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="FALSE" />
    <define name="CALC_TAS_FACTOR" value="FALSE" />
    <define name="CALC_AMSL_BARO" value="TRUE" />
  </section>
  
  <!-- local magnetic field -->
  <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <!-- NL -->
    <define name="H_X" value="0.3892503" />
    <define name="H_Y" value="0.0017972" />
    <define name="H_Z" value="0.9211303" />

    <define name="GRAVITY_HEURISTIC_FACTOR" value="5"/>
  </section>
  
  <!-- No sonar, (...yet) -->
  <section name="INS" prefix="INS_">
    <define name="SONAR_MAX_RANGE" value="4.0" />
    <define name="SONAR_UPDATE_ON_AGL" value="TRUE" />
  </section>
  
  <!-- ******** Classic ********* -->
  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI" value="45" unit="deg"/>
    <define name="SP_MAX_THETA" value="45" unit="deg"/>
    <define name="SP_MAX_R" value="300" unit="deg/s"/>
    <define name="DEADBAND_A" value="0"/>
    <define name="DEADBAND_E" value="0"/>
    <define name="DEADBAND_R" value="150"/>

    <!-- reference -->
    <define name="REF_OMEGA_P" value="400" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.9"/>
    <define name="REF_MAX_P" value="600." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(6000.)"/>

    <define name="REF_OMEGA_Q" value="400" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.9"/>
    <define name="REF_MAX_Q" value="600." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(6000.)"/>

    <define name="REF_OMEGA_R" value="200" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.9"/>
    <define name="REF_MAX_R" value="300." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(3000.)"/>

    <!-- feedback -->
    <define name="PHI_PGAIN" value="800"/>
    <define name="PHI_DGAIN" value="400"/>
    <define name="PHI_IGAIN" value="0"/>

    <define name="THETA_PGAIN" value="800"/>
    <define name="THETA_DGAIN" value="400"/>
    <define name="THETA_IGAIN" value="0"/>

    <define name="PSI_PGAIN" value="1000"/>
    <define name="PSI_DGAIN" value="500"/>
    <define name="PSI_IGAIN" value="0"/>

    <!-- feedforward -->
    <define name="PHI_DDGAIN" value="0"/>
    <define name="THETA_DDGAIN" value="0"/>
    <define name="PSI_DDGAIN" value="100"/>
  </section>
  

  <!-- ****If INDI is used later on **** -->
  <!-- 
  <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
    <define name="SP_MAX_PHI" value="45" unit="deg" />
    <define name="SP_MAX_THETA" value="45" unit="deg" />
    <define name="SP_MAX_R" value="300" unit="deg/s" />
    <define name="DEADBAND_A" value="0" />
    <define name="DEADBAND_E" value="0" />
    <define name="DEADBAND_R" value="50" />
  </section>
  
  <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <define name="REF_OMEGA_P" value="450" unit="deg/s" />
    <define name="REF_ZETA_P" value="0.9" />
    <define name="REF_MAX_P" value="600." unit="deg/s" />
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)" />
    <define name="REF_OMEGA_Q" value="450" unit="deg/s" />
    <define name="REF_ZETA_Q" value="0.9" />
    <define name="REF_MAX_Q" value="600." unit="deg/s" />
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)" />
    <define name="REF_OMEGA_R" value="450" unit="deg/s" />
    <define name="REF_ZETA_R" value="0.9" />
    <define name="REF_MAX_R" value="600." unit="deg/s" />
    <define name="REF_MAX_RDOT" value="RadOfDeg(8000.)" />
  </section>
   
  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">

    <define name="G1_P" value="0.016" />
    <define name="G1_Q" value="0.016" />
    <define name="G1_R" value="0.001" />
    <define name="G2_R" value="0.08" />

    <define name="FILTER_ROLL_RATE" value="FALSE" />
    <define name="FILTER_PITCH_RATE" value="FALSE" />
    <define name="FILTER_YAW_RATE" value="FALSE" />

    <define name="REF_ERR_P" value="100.0" />
    <define name="REF_ERR_Q" value="100.0" />
    <define name="REF_ERR_R" value="100.0" />
    <define name="REF_RATE_P" value="15.0" />
    <define name="REF_RATE_Q" value="15.0" />
    <define name="REF_RATE_R" value="15.0" />

    <define name="FILT_CUTOFF" value="3.0"/>
    <define name="FILT_CUTOFF_R" value="3.0"/>

    <define name="ACT_DYN_P" value="0.05" />
    <define name="ACT_DYN_Q" value="0.05" />
    <define name="ACT_DYN_R" value="0.05" />

    <define name="USE_ADAPTIVE" value="TRUE" />
    <define name="ADAPTIVE_MU" value="0.005" />

    <define name="STABILIZATION_INDI_MAX_RATE" value="300." unit="deg/s" />
    <define name="STABILIZATION_INDI_MAX_R" value="120." unit="deg/s" />
  </section>
  -->
  
  <section name="AUTOPILOT">    
    <define name="MODE_STARTUP" value="AP_MODE_RC_DIRECT" />
    <define name="MODE_MANUAL" value="AP_MODE_RC_DIRECT" />
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_DIRECT" />
    <define name="MODE_AUTO2" value="AP_MODE_ATTITUDE_Z_HOLD" />
    <define name="USE_THROTTLE_FOR_MOTOR_ARMING" value="TRUE"/><!-- Set to whatever deems safer...  -->
    <define name="NO_RC_THRUST_LIMIT" value="TRUE" />
  </section>
  
  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="55000" /><!-- TODO set total capacity -->
    <define name="CATASTROPHIC_BAT_LEVEL" value="5" unit="V" />
    <define name="CRITIC_BAT_LEVEL" value="5.5" unit="V" />
    <define name="LOW_BAT_LEVEL" value="5.7" unit="V" />
    <define name="MAX_BAT_LEVEL" value="6.6" unit="V" />
  </section>
  
  <!-- TODO: Tune -->
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="MAX_BANK" value="45" unit="deg" />
    <define name="REF_MAX_SPEED" value="15" unit="m/s" />
    <define name="PGAIN" value="200" />
    <define name="DGAIN" value="50" />
    <define name="IGAIN" value="25" />
  </section>
    
  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="400" />
    <define name="HOVER_KD" value="90" />
    <define name="HOVER_KI" value="30" />
    <define name="NOMINAL_HOVER_THROTTLE" value="0.3" />
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE" />
  </section>
  
  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="7.0" unit="m/s" />
    <define name="DESCEND_VSPEED" value="-4.0" unit="m/s" />
  </section>
    
</airframe>
