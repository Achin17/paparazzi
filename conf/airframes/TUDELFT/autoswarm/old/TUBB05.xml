<!DOCTYPE airframe SYSTEM "../../airframe.dtd">
<airframe name="TUBB05">
	<firmware name="rotorcraft">
		<configure name="HOST" value="192.168.40.5" />
		<configure name="MODEM_HOST" value="192.168.40.255" />
		<target name="ap" board="bebop" />
		<define name="MT9F002_OUTPUT_HEIGHT" value="1648" /> <!-- 1648 -->
		<define name="MT9F002_OUTPUT_WIDTH" value="1672" /> <!-- 1672 -->
		<define name="MT9F002_INITIAL_OFFSET_X" value="672" />
		<define name="MT9F002_INITIAL_OFFSET_Y" value="0" />
		<define name="MT9F002_OUTPUT_SCALER" value="1" /> <!-- 16/26 -->
		<define name="MT9F002_TARGET_FPS" value="30" />
		<define name="MT9F002_TARGET_EXPOSURE" value="40" /> <!-- Daylight: 10 -->
		<define name="MT9F002_GAIN_GREEN1" value="1.6" />
		<define name="MT9F002_GAIN_GREEN2" value="1.6" />
		<define name="MT9F002_X_ODD_INC_VAL" value="3" />
		<define name="MT9F002_Y_ODD_INC_VAL" value="3" />
		<target name="nps" board="pc">
			<module name="fdm" type="jsbsim" />
			<module name="udp" />
		</target>
		<!--define name="USE_SONAR" value="TRUE"/ -->
		<!-- Subsystem section -->
		<module name="telemetry" type="transparent_udp" />
		<module name="radio_control" type="datalink" />
		<module name="motor_mixing" />
		<module name="actuators" type="bebop" />
		<module name="imu" type="bebop" />
		<module name="gps" type="datalink" />
		<module name="stabilization" type="indi" />
		<module name="stabilization" type="rate_indi" />
		<module name="ahrs" type="int_cmpl_quat">
			<configure name="USE_MAGNETOMETER" value="FALSE" />
			<define name="AHRS_USE_GPS_HEADING" value="TRUE" />
		</module>
		<module name="ins" type="extended" />
		<module name="guidance" type="indi" />
	</firmware>
	<modules main_freq="512">
		<module name="geo_mag" />
		<module name="air_data" />
		<!-- <module name="send_imu_mag_current"/> -->
		<module name="video_thread">
		</module>
		<module name="autoswarm">
			<define name="AUTOSWARM_CAMERA" value="front_camera" />
			<define name="WV_INIT_GLOBAL_ATTRACTOR" value="2" />
		</module>
		<!-- module name="video_rtp_stream"> 
		  <define name="VIEWVIDEO_CAMERA" value="front_camera"/> 
		  <define name="VIEWVIDEO_DOWNSIZE_FACTOR" value="1"/> 
		  <define name="VIEWVIDEO_QUALITY_FACTOR" value="15"/>
		  <define name="VIEWVIDEO_SHOT_PATH" value="/data/ftp/internal_000"/> 
		</module -->
		<!--module name="logger_file"> <define name="FILE_LOGGER_PATH" value="/data/ftp/internal_000"/> 
			</module -->
	</modules>
	<!-- The IMU calibration can be quite important -->
	<!-- Follow the MAVLab video to see how you can calibrate it -->
	<!-- If your drone tends to always go forward check your primary flight display -->
	<!-- Put the drone on a table, if the horizon is not perfectly straight you might want -->
	<!-- to adjust your body to imu variables until it is -->
	<section name="IMU" prefix="IMU_">
		<!-- Magneto calibration -->
		<define name="MAG_X_NEUTRAL" value="18" />
		<define name="MAG_Y_NEUTRAL" value="157" />
		<define name="MAG_Z_NEUTRAL" value="49" />
		<define name="MAG_X_SENS" value="10.5007722373" integer="16" />
		<define name="MAG_Y_SENS" value="11.1147400462" integer="16" />
		<define name="MAG_Z_SENS" value="11.6479371722" integer="16" />

		<!-- Magneto current calibration -->
		<define name="MAG_X_CURRENT_COEF" value="0.0" />
		<define name="MAG_Y_CURRENT_COEF" value="0.0" />
		<define name="MAG_Z_CURRENT_COEF" value="0.0" />

		<define name="ACCEL_X_NEUTRAL" value="0" />
		<define name="ACCEL_Y_NEUTRAL" value="0" />
		<define name="ACCEL_Z_NEUTRAL" value="0.0" />

		<define name="BODY_TO_IMU_PHI" value="0." unit="deg" />
		<define name="BODY_TO_IMU_THETA" value="0." unit="deg" />
		<define name="BODY_TO_IMU_PSI" value="0." unit="deg" />
	</section>
	<commands>
		<axis name="PITCH" failsafe_value="0" />
		<axis name="ROLL" failsafe_value="0" />
		<axis name="YAW" failsafe_value="0" />
		<axis name="THRUST" failsafe_value="6000" />
	</commands>
	<!-- Old firmware 
	<servos driver="Default"> 
	  <servo name="TOP_RIGHT" no="0" min="3000" neutral="3000" max="12000"/> 
	  <servo name="TOP_LEFT" no="1" min="3000" neutral="3000" max="12000"/> 
	  <servo name="BOTTOM_LEFT" no="2" min="3000" neutral="3000" max="12000"/>
	  <servo name="BOTTOM_RIGHT" no="3" min="3000" neutral="3000" max="12000"/> 
	</servos> -->
	<servos driver="Default">
		<servo name="TOP_LEFT" no="0" min="3000" neutral="3000" max="12000" />
		<servo name="TOP_RIGHT" no="1" min="3000" neutral="3000" max="12000" />
		<servo name="BOTTOM_RIGHT" no="2" min="3000" neutral="3000" max="12000" />
		<servo name="BOTTOM_LEFT" no="3" min="3000" neutral="3000" max="12000" />
	</servos>
	<section name="MIXING" prefix="MOTOR_MIXING_">
		<!-- Time cross layout (X), with order NW (CW), NE (CCW), SE (CW), SW (CCW) -->
		<define name="TYPE" value="QUAD_X" />
	</section>
	<command_laws>
		<call fun="motor_mixing_run(autopilot_motors_on,FALSE,values)" />
		<set servo="TOP_LEFT" value="motor_mixing.commands[MOTOR_FRONT_LEFT]" />
		<set servo="TOP_RIGHT" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]" />
		<set servo="BOTTOM_RIGHT" value="motor_mixing.commands[MOTOR_BACK_RIGHT]" />
		<set servo="BOTTOM_LEFT" value="motor_mixing.commands[MOTOR_BACK_LEFT]" />
	</command_laws>
	<section name="AIR_DATA" prefix="AIR_DATA_">
		<define name="CALC_AIRSPEED" value="FALSE" />
		<define name="CALC_TAS_FACTOR" value="FALSE" />
		<define name="CALC_AMSL_BARO" value="TRUE" />
	</section>
	<!-- local magnetic field -->
	<!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
	<section name="AHRS" prefix="AHRS_">
		<!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
		<define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0" />
		<define name="GRAVITY_HEURISTIC_FACTOR" value="0" />   <!-- Fix the noise in INDI guidance for bebop -->
		<!-- Delft -->
		<define name="H_X" value="0.3892503" />
		<define name="H_Y" value="0.0017972" />
		<define name="H_Z" value="0.9211303" />
	</section>
	<section name="INS" prefix="INS_">
		<define name="SONAR_MAX_RANGE" value="2.2" />
		<define name="SONAR_UPDATE_ON_AGL" value="TRUE" />
		<define name="USE_GPS_ALT" value="TRUE" />
		<define name="VFF_R_GPS" value="0.01" /> <!-- TODO: must be tuned, probably higher -->
	</section>
	<section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
		<!-- setpoint limits for attitude stabilization rc flight -->
		<define name="SP_MAX_PHI" value="45" unit="deg" />
		<define name="SP_MAX_THETA" value="45" unit="deg" />
		<define name="SP_MAX_R" value="100" unit="deg/s" />
		<define name="DEADBAND_A" value="0" />
		<define name="DEADBAND_E" value="0" />
		<define name="DEADBAND_R" value="50" />
	</section>
	<section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
		<!-- setpoints -->
		<define name="SP_MAX_P" value="140" unit="deg/s" />
		<define name="SP_MAX_Q" value="140" unit="deg/s" />
		<define name="SP_MAX_R" value="140" unit="deg/s" />
		<define name="DEADBAND_P" value="20" />
		<define name="DEADBAND_Q" value="20" />
		<define name="DEADBAND_R" value="200" />

		<!-- feedback -->
		<define name="GAIN_P" value="400" />
		<define name="GAIN_Q" value="400" />
		<define name="GAIN_R" value="350" />

		<define name="IGAIN_P" value="75" />
		<define name="IGAIN_Q" value="75" />
		<define name="IGAIN_R" value="50" />
	</section>
	<section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
		<!-- control effectiveness -->
		<define name="G1_P" value="0.08" />
		<define name="G1_Q" value="0.0361" />
		<define name="G1_R" value="0.0022" />
		<define name="G2_R" value="0.1450" />

		<!-- reference acceleration for attitude control -->
		<define name="REF_ERR_P" value="320.0" />
		<define name="REF_ERR_Q" value="600.0" />
		<define name="REF_ERR_R" value="600.0" />
		<define name="REF_RATE_P" value="28.0" />
		<define name="REF_RATE_Q" value="28.0" />
		<define name="REF_RATE_R" value="28.0" />

		<!--Maxium yaw rate, to avoid instability -->
		<define name="MAX_R" value="90.0" /> <!-- deg/s TODO: lower this? -->

		<!-- second order filter parameters -->
		<define name="FILT_OMEGA" value="50.0" />
		<define name="FILT_ZETA" value="0.55" />
		<define name="FILT_OMEGA_R" value="50.0" />
		<define name="FILT_ZETA_R" value="0.55" />

		<!-- first order actuator dynamics -->
		<define name="ACT_DYN_P" value="0.1" />
		<define name="ACT_DYN_Q" value="0.1" />
		<define name="ACT_DYN_R" value="0.1" />

		<!-- Adaptive Learning Rate -->
		<define name="USE_ADAPTIVE" value="FALSE" />
		<define name="ADAPTIVE_MU" value="0.0001" />
	</section>

	<section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
		<!-- attitude reference generation model -->
		<define name="REF_OMEGA_P" value="450" unit="deg/s" />
		<define name="REF_ZETA_P" value="0.9" />
		<define name="REF_MAX_P" value="600." unit="deg/s" />
		<define name="REF_MAX_PDOT" value="RadOfDeg(8000.)" />

		<define name="REF_OMEGA_Q" value="450" unit="deg/s" />
		<define name="REF_ZETA_Q" value="0.9" />
		<define name="REF_MAX_Q" value="600." unit="deg/s" />
		<define name="REF_MAX_QDOT" value="RadOfDeg(8000.)" />

		<define name="REF_OMEGA_R" value="450" unit="deg/s" />
		<define name="REF_ZETA_R" value="0.9" />
		<define name="REF_MAX_R" value="600." unit="deg/s" />
		<define name="REF_MAX_RDOT" value="RadOfDeg(8000.)" />
	</section>

	<section name="GUIDANCE_V" prefix="GUIDANCE_V_">
		<define name="HOVER_KP" value="333" /> <!-- 283 -->
		<define name="HOVER_KD" value="102" /> <!-- 82 -->
		<define name="HOVER_KI" value="43" /> <!-- 13 -->
		<define name="NOMINAL_HOVER_THROTTLE" value="0.52" /> 		<!-- TODO: tune using adaptive OLD: 0.655 -->

		<define name="ADAPT_THROTTLE_ENABLED" value="TRUE" /> 		<!-- TODO: disable this? -->
		<define name="ADAPT_INITIAL_HOVER_THROTTLE" value="0.55" /> 	<!-- Default = 0.3 // 0.52 almost perfect -->
		<define name="ADAPT_MIN_HOVER_THROTTLE" value="0.48" /> 		<!-- Default = 0.2 // -->
		<define name="ADAPT_MAX_HOVER_THROTTLE" value="0.62" /> 		<!-- Default = 0.2 // -->
		<define name="ADAPT_NOISE_FACTOR" value="0.8" /> 			<!-- default = 1 -->
	</section>

	<section name="GUIDANCE_H" prefix="GUIDANCE_H_">
		<!-- Good weather -->
		<define name="MAX_BANK" value="30" unit="deg" />
		<!-- Bad weather -->
		<!-- define name="MAX_BANK" value="32" unit="deg"/ -->
		<define name="PGAIN" value="100" /> <!-- 90 sluggish / 120 probably too agressive -->
		<define name="DGAIN" value="150" />
		<define name="IGAIN" value="50" /> <!--was: 40 / 60 probably too agressive -->
	</section>

	<section name="NAVIGATION" prefix="NAV_">
		<define name="CLIMB_VSPEED" value="2.5" />
		<define name="DESCEND_VSPEED" value="-0.55" />
	</section>

	<!-- Here you put the modes that your drone can fly in -->
	<!-- If you are using a hobbyking joystick mode_manual and mode_auto2 have to be set -->
	<!-- These settings are probably ok for your project! -->
	<section name="AUTOPILOT">
		<define name="MODE_STARTUP" value="AP_MODE_NAV" />
		<define name="MODE_MANUAL" value="AP_MODE_HOVER_Z_HOLD" />
		<define name="MODE_AUTO1" value="AP_MODE_HOVER_Z_HOLD" />
		<define name="MODE_AUTO2" value="AP_MODE_NAV" />
	</section>

	<section name="BAT">
		<define name="MILLIAMP_AT_FULL_THROTTLE" value="8700" />
		<define name="CATASTROPHIC_BAT_LEVEL" value="10.8" unit="V" />
		<define name="CRITIC_BAT_LEVEL" value="11.0" unit="V" />
		<define name="LOW_BAT_LEVEL" value="11.2" unit="V" />
		<define name="MAX_BAT_LEVEL" value="12.4" unit="V" />
	</section>
</airframe>